<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 7.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":false,"style":"default"},"back2top":{"enable":true,"sidebar":true,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":true,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":"gitalk","storage":true,"lazyload":false,"nav":{"gitalk":{"text":"评论","order":-2}},"activeClass":"gitalk"},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="本文介绍Koa框架的基本使用">
<meta property="og:type" content="article">
<meta property="og:title" content="Koa 框架使用">
<meta property="og:url" content="http://example.com/2025/08/25/Koa/index.html">
<meta property="og:site_name" content="木语">
<meta property="og:description" content="本文介绍Koa框架的基本使用">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2025-08-25T05:20:00.000Z">
<meta property="article:modified_time" content="2025-08-27T08:04:33.278Z">
<meta property="article:author" content="koen">
<meta property="article:tag" content="Koa">
<meta property="article:tag" content="backen">
<meta property="article:tag" content="nodejs">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://example.com/2025/08/25/Koa/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'en'
  };
</script>

  <title>Koa 框架使用 | 木语</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

   <link rel="stylesheet" href="/dist/APlayer.min.css">
<style>mjx-container[jax="SVG"] {
  direction: ltr;
}

mjx-container[jax="SVG"] > svg {
  overflow: visible;
}

mjx-container[jax="SVG"][display="true"] {
  display: block;
  text-align: center;
  margin: 1em 0;
}

mjx-container[jax="SVG"][justify="left"] {
  text-align: left;
}

mjx-container[jax="SVG"][justify="right"] {
  text-align: right;
}

g[data-mml-node="merror"] > g {
  fill: red;
  stroke: red;
}

g[data-mml-node="merror"] > rect[data-background] {
  fill: yellow;
  stroke: none;
}

g[data-mml-node="mtable"] > line[data-line] {
  stroke-width: 70px;
  fill: none;
}

g[data-mml-node="mtable"] > rect[data-frame] {
  stroke-width: 70px;
  fill: none;
}

g[data-mml-node="mtable"] > .mjx-dashed {
  stroke-dasharray: 140;
}

g[data-mml-node="mtable"] > .mjx-dotted {
  stroke-linecap: round;
  stroke-dasharray: 0,140;
}

g[data-mml-node="mtable"] > svg {
  overflow: visible;
}

[jax="SVG"] mjx-tool {
  display: inline-block;
  position: relative;
  width: 0;
  height: 0;
}

[jax="SVG"] mjx-tool > mjx-tip {
  position: absolute;
  top: 0;
  left: 0;
}

mjx-tool > mjx-tip {
  display: inline-block;
  padding: .2em;
  border: 1px solid #888;
  font-size: 70%;
  background-color: #F8F8F8;
  color: black;
  box-shadow: 2px 2px 5px #AAAAAA;
}

g[data-mml-node="maction"][data-toggle] {
  cursor: pointer;
}

mjx-status {
  display: block;
  position: fixed;
  left: 1em;
  bottom: 1em;
  min-width: 25%;
  padding: .2em .4em;
  border: 1px solid #888;
  font-size: 90%;
  background-color: #F8F8F8;
  color: black;
}

foreignObject[data-mjx-xml] {
  font-family: initial;
  line-height: normal;
  overflow: visible;
}

.MathJax path {
  stroke-width: 3;
}

mjx-container[display="true"] {
  overflow: auto hidden;
}

mjx-container[display="true"] + br {
  display: none;
}
</style><link rel="alternate" href="/atom.xml" title="木语" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">木语</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">技术是逻辑，木是自然，语是表达</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/08/25/Koa/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/./images/head.jpg">
      <meta itemprop="name" content="koen">
      <meta itemprop="description" content="Spark!">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="木语">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Koa 框架使用
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2025-08-25 13:20:00" itemprop="dateCreated datePublished" datetime="2025-08-25T13:20:00+08:00">2025-08-25</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-08-27 16:04:33" itemprop="dateModified" datetime="2025-08-27T16:04:33+08:00">2025-08-27</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/code/" itemprop="url" rel="index"><span itemprop="name">code</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Views" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span id="busuanzi_value_page_pv"></span>
            </span>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>2.9k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>3 mins.</span>
            </span>
            <div class="post-description">本文介绍Koa框架的基本使用</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h2 id="准备工作">0. 准备工作</h2>
<h3 id="安装-node.js建议-node-18">0.1 安装 Node.js（建议 Node 18+）</h3>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">node -v</span><br><span class="line"><span class="comment"># v18.x 或更高</span></span><br></pre></td></tr></table></figure>
<h3 id="新建项目目录并初始化">0.2 新建项目目录并初始化</h3>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> koa-step-by-step</span><br><span class="line"><span class="built_in">cd</span> koa-step-by-step</span><br><span class="line">npm init -y</span><br></pre></td></tr></table></figure>
<h3 id="esm-设置强烈建议">0.3 ESM 设置（强烈建议）</h3>
<p>在 <code>package.json</code> 顶层加入： <figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">{</span></span><br><span class="line">  <span class="attr">"type"</span><span class="punctuation">:</span> <span class="string">"module"</span></span><br><span class="line"><span class="punctuation">}</span></span><br></pre></td></tr></table></figure> &gt; 作用：让
Node 默认使用 ES
模块语法（<code>import</code>/<code>export</code>），并支持
<code>.mjs</code> 文件。</p>
<h3 id="推荐本地开发脚本可热重载">0.4 推荐本地开发脚本（可热重载）</h3>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i -D nodemon</span><br></pre></td></tr></table></figure>
<p>在 <code>package.json</code> 里加入： <figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">{</span></span><br><span class="line">  <span class="attr">"scripts"</span><span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">    <span class="attr">"dev"</span><span class="punctuation">:</span> <span class="string">"nodemon --ext mjs,js,json --watch . app.mjs"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"start"</span><span class="punctuation">:</span> <span class="string">"node app.mjs"</span></span><br><span class="line">  <span class="punctuation">}</span></span><br><span class="line"><span class="punctuation">}</span></span><br></pre></td></tr></table></figure> &gt; 以后
<code>npm run dev</code> 就会自动重启，开发体验更好。</p>
<hr>
<h2 id="阶段-a最小可运行的-koa无路由无中间件栈">1. 阶段 A：最小可运行的
Koa（无路由、无中间件栈）</h2>
<h3 id="安装-koa">1.1 安装 Koa</h3>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i koa</span><br></pre></td></tr></table></figure>
<h3 id="新建-app.mjs">1.2 新建 <code>app.mjs</code></h3>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app.mjs（阶段A）</span></span><br><span class="line"><span class="comment">// 目标：</span></span><br><span class="line"><span class="comment">// 1）启动一个最简单的 Koa 服务器</span></span><br><span class="line"><span class="comment">// 2）所有请求都返回 "Hello Koa" 文本</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Koa</span> <span class="keyword">from</span> <span class="string">'koa'</span>;   <span class="comment">// 引入 Koa 主类</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> <span class="title class_">Koa</span>();   <span class="comment">// 创建 Koa 实例</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// app.use() 注册一个中间件函数（每个请求都会走这里）</span></span><br><span class="line"><span class="comment">// 这是最简单的中间件：设置响应体即可</span></span><br><span class="line">app.<span class="title function_">use</span>(<span class="title function_">async</span> (ctx) =&gt; {</span><br><span class="line">  <span class="comment">// ctx 是“上下文对象”，封装了 Request 和 Response 等常用属性</span></span><br><span class="line">  ctx.<span class="property">body</span> = <span class="string">'Hello Koa'</span>; <span class="comment">// 返回纯文本</span></span><br><span class="line">});</span><br><span class="line"></span><br><span class="line"><span class="comment">// 启动 HTTP 服务，监听端口 3000</span></span><br><span class="line">app.<span class="title function_">listen</span>(<span class="number">3000</span>, <span class="function">() =&gt;</span> {</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">'✅ Server running at http://localhost:3000'</span>);</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">'   当前阶段：A（最小可运行服务）'</span>);</span><br><span class="line">});</span><br></pre></td></tr></table></figure>
<h3 id="运行">1.3 运行</h3>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">npm run start</span><br><span class="line"><span class="comment"># 或</span></span><br><span class="line">npm run dev</span><br></pre></td></tr></table></figure>
<p>浏览器打开 http://localhost:3000 ，能看到 <strong>Hello
Koa</strong>。</p>
<hr>
<h2 id="阶段-b引入路由koa-router让不同路径走不同逻辑">2. 阶段
B：引入路由（koa-router），让不同路径走不同逻辑</h2>
<h3 id="安装路由中间件">2.1 安装路由中间件</h3>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i koa-router</span><br></pre></td></tr></table></figure>
<h3 id="新建-routesindex.mjs">2.2 新建
<code>routes/index.mjs</code></h3>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// routes/index.mjs（阶段B）</span></span><br><span class="line"><span class="comment">// 目标：为不同 URL 配置不同处理函数</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Router</span> <span class="keyword">from</span> <span class="string">'koa-router'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建路由实例，并统一加上前缀（可选）</span></span><br><span class="line"><span class="keyword">const</span> router = <span class="keyword">new</span> <span class="title class_">Router</span>({ <span class="attr">prefix</span>: <span class="string">'/api'</span> });</span><br><span class="line"></span><br><span class="line"><span class="comment">// GET /api/hello -&gt; 返回简单文本</span></span><br><span class="line">router.<span class="title function_">get</span>(<span class="string">'/hello'</span>, <span class="title function_">async</span> (ctx) =&gt; {</span><br><span class="line">  ctx.<span class="property">body</span> = <span class="string">'Hello from /api/hello'</span>;</span><br><span class="line">});</span><br><span class="line"></span><br><span class="line"><span class="comment">// GET /api/user/:id -&gt; 返回路径参数</span></span><br><span class="line">router.<span class="title function_">get</span>(<span class="string">'/user/:id'</span>, <span class="title function_">async</span> (ctx) =&gt; {</span><br><span class="line">  <span class="comment">// 通过 ctx.params 获取 :id 的值</span></span><br><span class="line">  <span class="keyword">const</span> { id } = ctx.<span class="property">params</span>;</span><br><span class="line">  ctx.<span class="property">body</span> = { <span class="attr">message</span>: <span class="string">`你请求的用户ID是 <span class="subst">${id}</span>`</span> };</span><br><span class="line">});</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> router;</span><br></pre></td></tr></table></figure>
<h3 id="修改-app.mjs-使用路由">2.3 修改 <code>app.mjs</code>
使用路由</h3>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app.mjs（阶段B）</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Koa</span> <span class="keyword">from</span> <span class="string">'koa'</span>;</span><br><span class="line"><span class="keyword">import</span> router <span class="keyword">from</span> <span class="string">'./routes/index.mjs'</span>; <span class="comment">// 引入路由</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> <span class="title class_">Koa</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 将路由注册到应用（注意两步：routes + allowedMethods）</span></span><br><span class="line">app.<span class="title function_">use</span>(router.<span class="title function_">routes</span>());</span><br><span class="line">app.<span class="title function_">use</span>(router.<span class="title function_">allowedMethods</span>());</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">listen</span>(<span class="number">3000</span>, <span class="function">() =&gt;</span> {</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">'✅ Server running at http://localhost:3000'</span>);</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">'   当前阶段：B（已加入路由）'</span>);</span><br><span class="line">});</span><br></pre></td></tr></table></figure>
<p>此时访问： - GET <code>http://localhost:3000/api/hello</code> - GET
<code>http://localhost:3000/api/user/123</code></p>
<hr>
<h2 id="阶段-c解析请求体koa-bodyparser并实现第一个-post-api">3. 阶段
C：解析请求体（koa-bodyparser）并实现第一个 POST API</h2>
<h3 id="安装-body-解析中间件">3.1 安装 body 解析中间件</h3>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i koa-bodyparser</span><br></pre></td></tr></table></figure>
<h3 id="在-app.mjs-启用-bodyparser">3.2 在 <code>app.mjs</code> 启用
bodyParser</h3>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app.mjs（阶段C）</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Koa</span> <span class="keyword">from</span> <span class="string">'koa'</span>;</span><br><span class="line"><span class="keyword">import</span> bodyParser <span class="keyword">from</span> <span class="string">'koa-bodyparser'</span>;</span><br><span class="line"><span class="keyword">import</span> router <span class="keyword">from</span> <span class="string">'./routes/index.mjs'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> <span class="title class_">Koa</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 解析 JSON / x-www-form-urlencoded 请求体</span></span><br><span class="line">app.<span class="title function_">use</span>(<span class="title function_">bodyParser</span>());</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">use</span>(router.<span class="title function_">routes</span>());</span><br><span class="line">app.<span class="title function_">use</span>(router.<span class="title function_">allowedMethods</span>());</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">listen</span>(<span class="number">3000</span>, <span class="function">() =&gt;</span> {</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">'✅ Server running at http://localhost:3000'</span>);</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">'   当前阶段：C（支持解析请求体 &amp; POST 请求）'</span>);</span><br><span class="line">});</span><br></pre></td></tr></table></figure>
<h3 id="在路由里加一个-post-示例">3.3 在路由里加一个 POST 示例</h3>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// routes/index.mjs（阶段C，新增 POST 路由）</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Router</span> <span class="keyword">from</span> <span class="string">'koa-router'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> router = <span class="keyword">new</span> <span class="title class_">Router</span>({ <span class="attr">prefix</span>: <span class="string">'/api'</span> });</span><br><span class="line"></span><br><span class="line">router.<span class="title function_">get</span>(<span class="string">'/hello'</span>, <span class="title function_">async</span> (ctx) =&gt; {</span><br><span class="line">  ctx.<span class="property">body</span> = <span class="string">'Hello from /api/hello'</span>;</span><br><span class="line">});</span><br><span class="line"></span><br><span class="line">router.<span class="title function_">get</span>(<span class="string">'/user/:id'</span>, <span class="title function_">async</span> (ctx) =&gt; {</span><br><span class="line">  <span class="keyword">const</span> { id } = ctx.<span class="property">params</span>;</span><br><span class="line">  ctx.<span class="property">body</span> = { <span class="attr">message</span>: <span class="string">`你请求的用户ID是 <span class="subst">${id}</span>`</span> };</span><br><span class="line">});</span><br><span class="line"></span><br><span class="line"><span class="comment">// POST /api/echo -&gt; 回显请求体</span></span><br><span class="line">router.<span class="title function_">post</span>(<span class="string">'/echo'</span>, <span class="title function_">async</span> (ctx) =&gt; {</span><br><span class="line">  <span class="comment">// 通过 ctx.request.body 获取 JSON 或表单提交的数据</span></span><br><span class="line">  <span class="keyword">const</span> body = ctx.<span class="property">request</span>.<span class="property">body</span>;</span><br><span class="line">  ctx.<span class="property">body</span> = {</span><br><span class="line">    <span class="attr">received</span>: body,  <span class="comment">// 回显你发过来的数据</span></span><br><span class="line">    <span class="attr">tip</span>: <span class="string">'你已成功通过 POST 发送数据到 Koa 服务端'</span></span><br><span class="line">  };</span><br><span class="line">});</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> router;</span><br></pre></td></tr></table></figure>
<p><strong>测试 POST：</strong> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Mac/Linux</span></span><br><span class="line">curl -X POST http://localhost:3000/api/echo \</span><br><span class="line">  -H <span class="string">"Content-Type: application/json"</span> \</span><br><span class="line">  -d <span class="string">'{"name":"Alice","age":20}'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Windows PowerShell（注意引号）</span></span><br><span class="line">curl -X POST http://localhost:3000/api/echo `</span><br><span class="line">  -H <span class="string">"Content-Type: application/json"</span> `</span><br><span class="line">  -d <span class="string">"{"</span><span class="string">"name"</span><span class="string">":"</span><span class="string">"Alice"</span><span class="string">","</span><span class="string">"age"</span><span class="string">":20}"</span></span><br></pre></td></tr></table></figure></p>
<hr>
<h2 id="阶段-d全局错误处理-日志打印理解洋葱模型">4. 阶段 D：全局错误处理
+ 日志打印（理解“洋葱模型”）</h2>
<h3 id="在-app.mjs-添加错误捕获中间件">4.1 在 <code>app.mjs</code>
添加错误捕获中间件</h3>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app.mjs（阶段D）</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Koa</span> <span class="keyword">from</span> <span class="string">'koa'</span>;</span><br><span class="line"><span class="keyword">import</span> bodyParser <span class="keyword">from</span> <span class="string">'koa-bodyparser'</span>;</span><br><span class="line"><span class="keyword">import</span> router <span class="keyword">from</span> <span class="string">'./routes/index.mjs'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> <span class="title class_">Koa</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// ① 全局错误处理中间件（最外层）：try/catch 所有下游中间件的异常</span></span><br><span class="line">app.<span class="title function_">use</span>(<span class="title function_">async</span> (ctx, next) =&gt; {</span><br><span class="line">  <span class="keyword">const</span> start = <span class="title class_">Date</span>.<span class="title function_">now</span>(); <span class="comment">// 统计耗时</span></span><br><span class="line">  <span class="keyword">try</span> {</span><br><span class="line">    <span class="keyword">await</span> <span class="title function_">next</span>();           <span class="comment">// 交给下一个中间件</span></span><br><span class="line">  } <span class="keyword">catch</span> (err) {</span><br><span class="line">    <span class="comment">// 统一错误响应格式</span></span><br><span class="line">    ctx.<span class="property">status</span> = err.<span class="property">status</span> || <span class="number">500</span>;</span><br><span class="line">    ctx.<span class="property">body</span> = { <span class="attr">code</span>: ctx.<span class="property">status</span>, <span class="attr">message</span>: err.<span class="property">message</span> || <span class="string">'Server Error'</span> };</span><br><span class="line">    <span class="comment">// 打印到控制台方便定位</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">'❌ Error:'</span>, err);</span><br><span class="line">  } <span class="keyword">finally</span> {</span><br><span class="line">    <span class="keyword">const</span> ms = <span class="title class_">Date</span>.<span class="title function_">now</span>() - start;</span><br><span class="line">    <span class="comment">// 记录访问日志</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`<span class="subst">${ctx.method}</span> <span class="subst">${ctx.url}</span> - <span class="subst">${ctx.status || <span class="number">200</span>}</span> <span class="subst">${ms}</span>ms`</span>);</span><br><span class="line">  }</span><br><span class="line">});</span><br><span class="line"></span><br><span class="line"><span class="comment">// ② 解析请求体</span></span><br><span class="line">app.<span class="title function_">use</span>(<span class="title function_">bodyParser</span>());</span><br><span class="line"></span><br><span class="line"><span class="comment">// ③ 注册业务路由</span></span><br><span class="line">app.<span class="title function_">use</span>(router.<span class="title function_">routes</span>());</span><br><span class="line">app.<span class="title function_">use</span>(router.<span class="title function_">allowedMethods</span>());</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">listen</span>(<span class="number">3000</span>, <span class="function">() =&gt;</span> {</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">'✅ Server running at http://localhost:3000'</span>);</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">'   当前阶段：D（全局错误处理 &amp; 访问日志）'</span>);</span><br><span class="line">});</span><br></pre></td></tr></table></figure>
<p><strong>理解洋葱模型</strong>：最外层中间件先进入，<code>await next()</code>
后进入下一层；当下一层返回时，回到上一层继续执行 <code>finally</code>
等收尾逻辑。</p>
<h3 id="在路由里人为抛错试试看">4.2 在路由里人为抛错试试看</h3>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// routes/index.mjs（阶段D，增加一个错误示例）</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Router</span> <span class="keyword">from</span> <span class="string">'koa-router'</span>;</span><br><span class="line"><span class="keyword">const</span> router = <span class="keyword">new</span> <span class="title class_">Router</span>({ <span class="attr">prefix</span>: <span class="string">'/api'</span> });</span><br><span class="line"></span><br><span class="line">router.<span class="title function_">get</span>(<span class="string">'/boom'</span>, <span class="title function_">async</span> () =&gt; {</span><br><span class="line">  <span class="comment">// 主动抛出一个错误，观察上文错误处理中间件如何工作</span></span><br><span class="line">  <span class="keyword">const</span> err = <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">'模拟服务端异常：/api/boom'</span>);</span><br><span class="line">  err.<span class="property">status</span> = <span class="number">418</span>; <span class="comment">// 仅演示，418是Teapot彩蛋状态码</span></span><br><span class="line">  <span class="keyword">throw</span> err;</span><br><span class="line">});</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> router;</span><br></pre></td></tr></table></figure>
<p>访问 <code>GET /api/boom</code>，你会看到结构化的错误响应 +
控制台日志。</p>
<hr>
<h2 id="阶段-e静态资源与-favicon避免多次计数404">5. 阶段 E：静态资源与
favicon（避免多次计数/404）</h2>
<h3 id="安装-koa-static">5.1 安装 koa-static</h3>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i koa-static</span><br></pre></td></tr></table></figure>
<h3 id="在项目根目录建-public">5.2 在项目根目录建
<code>public/</code></h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">koa-step-by-step/</span><br><span class="line">├─ app.mjs</span><br><span class="line">├─ routes/</span><br><span class="line">│  └─ index.mjs</span><br><span class="line">└─ public/</span><br><span class="line">   ├─ index.html</span><br><span class="line">   └─ favicon.ico (可选)</span><br></pre></td></tr></table></figure>
<p>简单写一个 <code>public/index.html</code>： <figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!doctype <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">head</span>&gt;</span><span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"utf-8"</span>&gt;</span><span class="tag">&lt;<span class="name">title</span>&gt;</span>Koa Static<span class="tag">&lt;/<span class="name">title</span>&gt;</span><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h1</span>&gt;</span>Hello Static<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span>这是 public/index.html 静态页面。<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<h3 id="修改-app.mjs-启用静态资源">5.3 修改 <code>app.mjs</code>
启用静态资源</h3>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app.mjs（阶段E）</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Koa</span> <span class="keyword">from</span> <span class="string">'koa'</span>;</span><br><span class="line"><span class="keyword">import</span> bodyParser <span class="keyword">from</span> <span class="string">'koa-bodyparser'</span>;</span><br><span class="line"><span class="keyword">import</span> serve <span class="keyword">from</span> <span class="string">'koa-static'</span>;</span><br><span class="line"><span class="keyword">import</span> path <span class="keyword">from</span> <span class="string">'path'</span>;</span><br><span class="line"><span class="keyword">import</span> { fileURLToPath } <span class="keyword">from</span> <span class="string">'url'</span>;</span><br><span class="line"><span class="keyword">import</span> router <span class="keyword">from</span> <span class="string">'./routes/index.mjs'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> __filename = <span class="title function_">fileURLToPath</span>(<span class="keyword">import</span>.<span class="property">meta</span>.<span class="property">url</span>);</span><br><span class="line"><span class="keyword">const</span> __dirname = path.<span class="title function_">dirname</span>(__filename);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> <span class="title class_">Koa</span>();</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">use</span>(<span class="title function_">async</span> (ctx, next) =&gt; {</span><br><span class="line">  <span class="keyword">const</span> start = <span class="title class_">Date</span>.<span class="title function_">now</span>();</span><br><span class="line">  <span class="keyword">try</span> {</span><br><span class="line">    <span class="keyword">await</span> <span class="title function_">next</span>();</span><br><span class="line">  } <span class="keyword">catch</span> (err) {</span><br><span class="line">    ctx.<span class="property">status</span> = err.<span class="property">status</span> || <span class="number">500</span>;</span><br><span class="line">    ctx.<span class="property">body</span> = { <span class="attr">code</span>: ctx.<span class="property">status</span>, <span class="attr">message</span>: err.<span class="property">message</span> || <span class="string">'Server Error'</span> };</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">'❌ Error:'</span>, err);</span><br><span class="line">  } <span class="keyword">finally</span> {</span><br><span class="line">    <span class="keyword">const</span> ms = <span class="title class_">Date</span>.<span class="title function_">now</span>() - start;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`<span class="subst">${ctx.method}</span> <span class="subst">${ctx.url}</span> - <span class="subst">${ctx.status || <span class="number">200</span>}</span> <span class="subst">${ms}</span>ms`</span>);</span><br><span class="line">  }</span><br><span class="line">});</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">use</span>(<span class="title function_">bodyParser</span>());</span><br><span class="line"></span><br><span class="line"><span class="comment">// 开放 public 目录为静态资源根目录：访问 / 即可打开 public/index.html</span></span><br><span class="line">app.<span class="title function_">use</span>(<span class="title function_">serve</span>(path.<span class="title function_">join</span>(__dirname, <span class="string">'public'</span>)));</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">use</span>(router.<span class="title function_">routes</span>());</span><br><span class="line">app.<span class="title function_">use</span>(router.<span class="title function_">allowedMethods</span>());</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">listen</span>(<span class="number">3000</span>, <span class="function">() =&gt;</span> {</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">'✅ Server running at http://localhost:3000'</span>);</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">'   当前阶段：E（支持静态资源与 favicon）'</span>);</span><br><span class="line">});</span><br></pre></td></tr></table></figure>
<p>现在访问 <code>http://localhost:3000/</code> 就能看到静态页面。</p>
<blockquote>
<p><strong>提示</strong>：许多浏览器会自动请求
<code>/favicon.ico</code>。如果没有图标，偶尔会触发两次访问等“小惊喜”。把
<code>favicon.ico</code> 放到 <code>public/</code>
里，可以避免这类困扰。</p>
</blockquote>
<hr>
<h2 id="阶段-f可选模板渲染服务器端渲染一个简单页面">6. 阶段
F（可选）：模板渲染（服务器端渲染一个简单页面）</h2>
<blockquote>
<p>如果你的服务只做 API，可跳过本节。这里展示如何用 <strong>EJS</strong>
渲染模板。</p>
</blockquote>
<h3 id="安装依赖">6.1 安装依赖</h3>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i koa-views ejs</span><br></pre></td></tr></table></figure>
<h3 id="目录结构新增-views">6.2 目录结构新增 <code>views/</code></h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">koa-step-by-step/</span><br><span class="line">├─ app.mjs</span><br><span class="line">├─ routes/</span><br><span class="line">│  └─ index.mjs</span><br><span class="line">├─ public/</span><br><span class="line">│  └─ index.html</span><br><span class="line">└─ views/</span><br><span class="line">   └─ home.ejs</span><br></pre></td></tr></table></figure>
<p><code>views/home.ejs</code>： <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;!doctype html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">  &lt;head&gt;&lt;meta charset="utf-8"&gt;&lt;title&gt;EJS Demo&lt;/title&gt;&lt;/head&gt;</span><br><span class="line">  &lt;body&gt;</span><br><span class="line">    &lt;h1&gt;&lt;%= title %&gt;&lt;/h1&gt;</span><br><span class="line">    &lt;p&gt;服务器时间：&lt;%= now %&gt;&lt;/p&gt;</span><br><span class="line">  &lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure></p>
<h3 id="在-app.mjs-配置视图中间件">6.3 在 <code>app.mjs</code>
配置视图中间件</h3>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app.mjs（阶段F）</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Koa</span> <span class="keyword">from</span> <span class="string">'koa'</span>;</span><br><span class="line"><span class="keyword">import</span> bodyParser <span class="keyword">from</span> <span class="string">'koa-bodyparser'</span>;</span><br><span class="line"><span class="keyword">import</span> serve <span class="keyword">from</span> <span class="string">'koa-static'</span>;</span><br><span class="line"><span class="keyword">import</span> views <span class="keyword">from</span> <span class="string">'koa-views'</span>;</span><br><span class="line"><span class="keyword">import</span> path <span class="keyword">from</span> <span class="string">'path'</span>;</span><br><span class="line"><span class="keyword">import</span> { fileURLToPath } <span class="keyword">from</span> <span class="string">'url'</span>;</span><br><span class="line"><span class="keyword">import</span> router <span class="keyword">from</span> <span class="string">'./routes/index.mjs'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> __filename = <span class="title function_">fileURLToPath</span>(<span class="keyword">import</span>.<span class="property">meta</span>.<span class="property">url</span>);</span><br><span class="line"><span class="keyword">const</span> __dirname = path.<span class="title function_">dirname</span>(__filename);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> <span class="title class_">Koa</span>();</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">use</span>(<span class="title function_">async</span> (ctx, next) =&gt; {</span><br><span class="line">  <span class="keyword">try</span> { <span class="keyword">await</span> <span class="title function_">next</span>(); } <span class="keyword">catch</span> (err) {</span><br><span class="line">    ctx.<span class="property">status</span> = err.<span class="property">status</span> || <span class="number">500</span>;</span><br><span class="line">    ctx.<span class="property">body</span> = { <span class="attr">code</span>: ctx.<span class="property">status</span>, <span class="attr">message</span>: err.<span class="property">message</span> || <span class="string">'Server Error'</span> };</span><br><span class="line">  }</span><br><span class="line">});</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">use</span>(<span class="title function_">bodyParser</span>());</span><br><span class="line">app.<span class="title function_">use</span>(<span class="title function_">serve</span>(path.<span class="title function_">join</span>(__dirname, <span class="string">'public'</span>)));</span><br><span class="line"></span><br><span class="line"><span class="comment">// 配置视图目录与模板引擎</span></span><br><span class="line">app.<span class="title function_">use</span>(<span class="title function_">views</span>(path.<span class="title function_">join</span>(__dirname, <span class="string">'views'</span>), { <span class="attr">extension</span>: <span class="string">'ejs'</span> }));</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">use</span>(router.<span class="title function_">routes</span>());</span><br><span class="line">app.<span class="title function_">use</span>(router.<span class="title function_">allowedMethods</span>());</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">listen</span>(<span class="number">3000</span>, <span class="function">() =&gt;</span> {</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">'✅ Server running at http://localhost:3000'</span>);</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">'   当前阶段：F（支持 EJS 模板渲染）'</span>);</span><br><span class="line">});</span><br></pre></td></tr></table></figure>
<h3 id="在路由中渲染一个页面">6.4 在路由中渲染一个页面</h3>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// routes/index.mjs（阶段F，新增 SSR 路由）</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Router</span> <span class="keyword">from</span> <span class="string">'koa-router'</span>;</span><br><span class="line"><span class="keyword">const</span> router = <span class="keyword">new</span> <span class="title class_">Router</span>({ <span class="attr">prefix</span>: <span class="string">'/api'</span> });</span><br><span class="line"></span><br><span class="line"><span class="comment">// ...前面的接口保留</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// GET /page/home -&gt; 渲染 EJS 模板（注意：此路由无 /api 前缀更合适，这里仅演示）</span></span><br><span class="line">router.<span class="title function_">get</span>(<span class="string">'/page/home'</span>, <span class="title function_">async</span> (ctx) =&gt; {</span><br><span class="line">  <span class="keyword">await</span> ctx.<span class="title function_">render</span>(<span class="string">'home'</span>, {</span><br><span class="line">    <span class="attr">title</span>: <span class="string">'EJS 模板渲染示例'</span>,</span><br><span class="line">    <span class="attr">now</span>: <span class="keyword">new</span> <span class="title class_">Date</span>().<span class="title function_">toLocaleString</span>()</span><br><span class="line">  });</span><br><span class="line">});</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> router;</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="阶段-g逐步rest-化-用内存数组先做-crud">7. 阶段 G：逐步“REST 化”
—— 用内存数组先做 CRUD</h2>
<blockquote>
<p>先<strong>不接数据库</strong>，用内存数组模拟数据源，把一套用户资源的
CRUD 接口打通，理解 REST 的路径与方法约定。</p>
</blockquote>
<h3 id="新建-routesusers.mjs">7.1 新建
<code>routes/users.mjs</code></h3>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// routes/users.mjs（阶段G）</span></span><br><span class="line"><span class="comment">// 目标：实现 RESTful 风格的用户资源接口（内存模拟数据库）</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Router</span> <span class="keyword">from</span> <span class="string">'koa-router'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> router = <span class="keyword">new</span> <span class="title class_">Router</span>({ <span class="attr">prefix</span>: <span class="string">'/api/users'</span> });</span><br><span class="line"></span><br><span class="line"><span class="comment">// 用一个内存数组模拟“数据库表”</span></span><br><span class="line"><span class="keyword">const</span> users = [</span><br><span class="line">  { <span class="attr">id</span>: <span class="number">1</span>, <span class="attr">name</span>: <span class="string">'Alice'</span>, <span class="attr">age</span>: <span class="number">20</span> },</span><br><span class="line">  { <span class="attr">id</span>: <span class="number">2</span>, <span class="attr">name</span>: <span class="string">'Bob'</span>,   <span class="attr">age</span>: <span class="number">22</span> }</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 工具：生成新ID（简单起见）</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">nextId</span> = (<span class="params"></span>) =&gt; (users.<span class="property">length</span> ? users[users.<span class="property">length</span> - <span class="number">1</span>].<span class="property">id</span> + <span class="number">1</span> : <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// GET /api/users  -&gt; 列表</span></span><br><span class="line">router.<span class="title function_">get</span>(<span class="string">'/'</span>, <span class="title function_">async</span> (ctx) =&gt; {</span><br><span class="line">  ctx.<span class="property">status</span> = <span class="number">200</span>;</span><br><span class="line">  ctx.<span class="property">body</span> = { <span class="attr">code</span>: <span class="number">200</span>, <span class="attr">data</span>: users };</span><br><span class="line">});</span><br><span class="line"></span><br><span class="line"><span class="comment">// GET /api/users/:id  -&gt; 详情</span></span><br><span class="line">router.<span class="title function_">get</span>(<span class="string">'/:id'</span>, <span class="title function_">async</span> (ctx) =&gt; {</span><br><span class="line">  <span class="keyword">const</span> id = <span class="title class_">Number</span>(ctx.<span class="property">params</span>.<span class="property">id</span>);</span><br><span class="line">  <span class="keyword">const</span> user = users.<span class="title function_">find</span>(<span class="function"><span class="params">u</span> =&gt;</span> u.<span class="property">id</span> === id);</span><br><span class="line">  <span class="keyword">if</span> (!user) {</span><br><span class="line">    ctx.<span class="keyword">throw</span>(<span class="number">404</span>, <span class="string">`用户 <span class="subst">${id}</span> 不存在`</span>);</span><br><span class="line">  }</span><br><span class="line">  ctx.<span class="property">body</span> = { <span class="attr">code</span>: <span class="number">200</span>, <span class="attr">data</span>: user };</span><br><span class="line">});</span><br><span class="line"></span><br><span class="line"><span class="comment">// POST /api/users  -&gt; 新增</span></span><br><span class="line">router.<span class="title function_">post</span>(<span class="string">'/'</span>, <span class="title function_">async</span> (ctx) =&gt; {</span><br><span class="line">  <span class="keyword">const</span> { name, age } = ctx.<span class="property">request</span>.<span class="property">body</span> || {};</span><br><span class="line">  <span class="keyword">if</span> (!name || <span class="keyword">typeof</span> age !== <span class="string">'number'</span>) {</span><br><span class="line">    ctx.<span class="keyword">throw</span>(<span class="number">400</span>, <span class="string">'参数不合法：需要 name(string) 与 age(number)'</span>);</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">const</span> newUser = { <span class="attr">id</span>: <span class="title function_">nextId</span>(), name, age };</span><br><span class="line">  users.<span class="title function_">push</span>(newUser);</span><br><span class="line">  ctx.<span class="property">status</span> = <span class="number">201</span>; <span class="comment">// 201：已创建</span></span><br><span class="line">  ctx.<span class="property">body</span> = { <span class="attr">code</span>: <span class="number">201</span>, <span class="attr">data</span>: newUser };</span><br><span class="line">});</span><br><span class="line"></span><br><span class="line"><span class="comment">// PUT /api/users/:id  -&gt; 全量更新</span></span><br><span class="line">router.<span class="title function_">put</span>(<span class="string">'/:id'</span>, <span class="title function_">async</span> (ctx) =&gt; {</span><br><span class="line">  <span class="keyword">const</span> id = <span class="title class_">Number</span>(ctx.<span class="property">params</span>.<span class="property">id</span>);</span><br><span class="line">  <span class="keyword">const</span> { name, age } = ctx.<span class="property">request</span>.<span class="property">body</span> || {};</span><br><span class="line">  <span class="keyword">const</span> idx = users.<span class="title function_">findIndex</span>(<span class="function"><span class="params">u</span> =&gt;</span> u.<span class="property">id</span> === id);</span><br><span class="line">  <span class="keyword">if</span> (idx === -<span class="number">1</span>) ctx.<span class="keyword">throw</span>(<span class="number">404</span>, <span class="string">`用户 <span class="subst">${id}</span> 不存在`</span>);</span><br><span class="line">  <span class="keyword">if</span> (!name || <span class="keyword">typeof</span> age !== <span class="string">'number'</span>) ctx.<span class="keyword">throw</span>(<span class="number">400</span>, <span class="string">'参数不合法：需要 name 与 age'</span>);</span><br><span class="line">  users[idx] = { id, name, age };</span><br><span class="line">  ctx.<span class="property">body</span> = { <span class="attr">code</span>: <span class="number">200</span>, <span class="attr">data</span>: users[idx] };</span><br><span class="line">});</span><br><span class="line"></span><br><span class="line"><span class="comment">// PATCH /api/users/:id -&gt; 部分更新（可选）</span></span><br><span class="line">router.<span class="title function_">patch</span>(<span class="string">'/:id'</span>, <span class="title function_">async</span> (ctx) =&gt; {</span><br><span class="line">  <span class="keyword">const</span> id = <span class="title class_">Number</span>(ctx.<span class="property">params</span>.<span class="property">id</span>);</span><br><span class="line">  <span class="keyword">const</span> patch = ctx.<span class="property">request</span>.<span class="property">body</span> || {};</span><br><span class="line">  <span class="keyword">const</span> user = users.<span class="title function_">find</span>(<span class="function"><span class="params">u</span> =&gt;</span> u.<span class="property">id</span> === id);</span><br><span class="line">  <span class="keyword">if</span> (!user) ctx.<span class="keyword">throw</span>(<span class="number">404</span>, <span class="string">`用户 <span class="subst">${id}</span> 不存在`</span>);</span><br><span class="line">  <span class="title class_">Object</span>.<span class="title function_">assign</span>(user, patch);</span><br><span class="line">  ctx.<span class="property">body</span> = { <span class="attr">code</span>: <span class="number">200</span>, <span class="attr">data</span>: user };</span><br><span class="line">});</span><br><span class="line"></span><br><span class="line"><span class="comment">// DELETE /api/users/:id -&gt; 删除</span></span><br><span class="line">router.<span class="title function_">delete</span>(<span class="string">'/:id'</span>, <span class="title function_">async</span> (ctx) =&gt; {</span><br><span class="line">  <span class="keyword">const</span> id = <span class="title class_">Number</span>(ctx.<span class="property">params</span>.<span class="property">id</span>);</span><br><span class="line">  <span class="keyword">const</span> idx = users.<span class="title function_">findIndex</span>(<span class="function"><span class="params">u</span> =&gt;</span> u.<span class="property">id</span> === id);</span><br><span class="line">  <span class="keyword">if</span> (idx === -<span class="number">1</span>) ctx.<span class="keyword">throw</span>(<span class="number">404</span>, <span class="string">`用户 <span class="subst">${id}</span> 不存在`</span>);</span><br><span class="line">  <span class="keyword">const</span> deleted = users.<span class="title function_">splice</span>(idx, <span class="number">1</span>)[<span class="number">0</span>];</span><br><span class="line">  ctx.<span class="property">body</span> = { <span class="attr">code</span>: <span class="number">200</span>, <span class="attr">data</span>: deleted };</span><br><span class="line">});</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> router;</span><br></pre></td></tr></table></figure>
<h3 id="在-app.mjs-中注册新路由文件">7.2 在 <code>app.mjs</code>
中注册新路由文件</h3>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app.mjs（阶段G）</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Koa</span> <span class="keyword">from</span> <span class="string">'koa'</span>;</span><br><span class="line"><span class="keyword">import</span> bodyParser <span class="keyword">from</span> <span class="string">'koa-bodyparser'</span>;</span><br><span class="line"><span class="keyword">import</span> serve <span class="keyword">from</span> <span class="string">'koa-static'</span>;</span><br><span class="line"><span class="keyword">import</span> path <span class="keyword">from</span> <span class="string">'path'</span>;</span><br><span class="line"><span class="keyword">import</span> { fileURLToPath } <span class="keyword">from</span> <span class="string">'url'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> baseRouter <span class="keyword">from</span> <span class="string">'./routes/index.mjs'</span>;</span><br><span class="line"><span class="keyword">import</span> usersRouter <span class="keyword">from</span> <span class="string">'./routes/users.mjs'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> __filename = <span class="title function_">fileURLToPath</span>(<span class="keyword">import</span>.<span class="property">meta</span>.<span class="property">url</span>);</span><br><span class="line"><span class="keyword">const</span> __dirname = path.<span class="title function_">dirname</span>(__filename);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> <span class="title class_">Koa</span>();</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">use</span>(<span class="title function_">async</span> (ctx, next) =&gt; {</span><br><span class="line">  <span class="keyword">try</span> { <span class="keyword">await</span> <span class="title function_">next</span>(); } <span class="keyword">catch</span> (err) {</span><br><span class="line">    ctx.<span class="property">status</span> = err.<span class="property">status</span> || <span class="number">500</span>;</span><br><span class="line">    ctx.<span class="property">body</span> = { <span class="attr">code</span>: ctx.<span class="property">status</span>, <span class="attr">message</span>: err.<span class="property">message</span> || <span class="string">'Server Error'</span> };</span><br><span class="line">  }</span><br><span class="line">});</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">use</span>(<span class="title function_">bodyParser</span>());</span><br><span class="line">app.<span class="title function_">use</span>(<span class="title function_">serve</span>(path.<span class="title function_">join</span>(__dirname, <span class="string">'public'</span>)));</span><br><span class="line"></span><br><span class="line"><span class="comment">// 注册多个路由模块</span></span><br><span class="line">app.<span class="title function_">use</span>(baseRouter.<span class="title function_">routes</span>()).<span class="title function_">use</span>(baseRouter.<span class="title function_">allowedMethods</span>());</span><br><span class="line">app.<span class="title function_">use</span>(usersRouter.<span class="title function_">routes</span>()).<span class="title function_">use</span>(usersRouter.<span class="title function_">allowedMethods</span>());</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">listen</span>(<span class="number">3000</span>, <span class="function">() =&gt;</span> {</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">'✅ Server running at http://localhost:3000'</span>);</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">'   当前阶段：G（RESTful 内存版 users 资源）'</span>);</span><br><span class="line">});</span><br></pre></td></tr></table></figure>
<p><strong>测试：</strong> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 列表</span></span><br><span class="line">curl http://localhost:3000/api/users</span><br><span class="line"></span><br><span class="line"><span class="comment"># 详情</span></span><br><span class="line">curl http://localhost:3000/api/users/1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 新增</span></span><br><span class="line">curl -X POST http://localhost:3000/api/users \</span><br><span class="line">  -H <span class="string">"Content-Type: application/json"</span> \</span><br><span class="line">  -d <span class="string">'{"name":"Carol","age":28}'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 更新</span></span><br><span class="line">curl -X PUT http://localhost:3000/api/users/1 \</span><br><span class="line">  -H <span class="string">"Content-Type: application/json"</span> \</span><br><span class="line">  -d <span class="string">'{"name":"Alice Updated","age":21}'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除</span></span><br><span class="line">curl -X DELETE http://localhost:3000/api/users/2</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p><strong>补充：CORS</strong> 若前端与后端不在同一域名/端口，需开启
CORS： <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i @koa/cors</span><br></pre></td></tr></table></figure> <figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> cors <span class="keyword">from</span> <span class="string">'@koa/cors'</span>;</span><br><span class="line">app.<span class="title function_">use</span>(<span class="title function_">cors</span>());</span><br></pre></td></tr></table></figure></p>
</blockquote>
<h3 id="如何实现数据库的增删改查cura">7.3
如何实现数据库的增删改查(CURA)</h3>
<p>数据库的四个基本功能</p>
<table>
<thead>
<tr>
<th>方法</th>
<th>描述</th>
<th>对应 SQL</th>
</tr>
</thead>
<tbody>
<tr>
<td>Create</td>
<td>新增一条记录</td>
<td>INSERT</td>
</tr>
<tr>
<td>Read</td>
<td>查询记录</td>
<td>SELECT</td>
</tr>
<tr>
<td>Update</td>
<td>更新记录</td>
<td>UPDATE</td>
</tr>
<tr>
<td>Delete</td>
<td>删除记录</td>
<td>DELETE</td>
</tr>
</tbody>
</table>
<p>在 RESTful API 中，常用 HTTP 方法对应 CRUD：</p>
<table>
<thead>
<tr>
<th>HTTP 方法</th>
<th>路径</th>
<th>CRUD</th>
</tr>
</thead>
<tbody>
<tr>
<td>GET</td>
<td>/api/users</td>
<td>查询所有用户</td>
</tr>
<tr>
<td>GET</td>
<td>/api/users/:id</td>
<td>查询单个用户</td>
</tr>
<tr>
<td>POST</td>
<td>/api/users</td>
<td>新增用户</td>
</tr>
<tr>
<td>PUT</td>
<td>/api/users/:id</td>
<td>全量更新用户</td>
</tr>
<tr>
<td>PATCH</td>
<td>/api/users/:id</td>
<td>部分更新用户</td>
</tr>
<tr>
<td>DELETE</td>
<td>/api/users/:id</td>
<td>删除用户</td>
</tr>
</tbody>
</table>
<p>首先在根目录创建<code>.env</code>文件</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">DB_HOST</span>=localhost</span><br><span class="line"><span class="attr">DB_USER</span>=root</span><br><span class="line"><span class="attr">DB_PASSWORD</span>=<span class="number">123456</span></span><br><span class="line"><span class="attr">DB_NAME</span>=testdb</span><br></pre></td></tr></table></figure>
<p>创建数据库模块<code>database/mysqldb.mjs</code>:</p>
<h2 id="section"><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> mysql <span class="keyword">from</span> <span class="string">'mysql2/promise'</span>;</span><br><span class="line"><span class="keyword">import</span> dotenv <span class="keyword">from</span> <span class="string">'dotenv'</span>;</span><br><span class="line">dotenv.<span class="title function_">config</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建连接池</span></span><br><span class="line"><span class="keyword">const</span> pool = mysql.<span class="title function_">createPool</span>({</span><br><span class="line">  <span class="attr">host</span>: process.<span class="property">env</span>.<span class="property">DB_HOST</span>,</span><br><span class="line">  <span class="attr">user</span>: process.<span class="property">env</span>.<span class="property">DB_USER</span>,</span><br><span class="line">  <span class="attr">password</span>: process.<span class="property">env</span>.<span class="property">DB_PASSWORD</span>,</span><br><span class="line">  <span class="attr">database</span>: process.<span class="property">env</span>.<span class="property">DB_NAME</span>,</span><br><span class="line">  <span class="attr">waitForConnections</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">connectionLimit</span>: <span class="number">10</span>,</span><br><span class="line">  <span class="attr">queueLimit</span>: <span class="number">0</span></span><br><span class="line">});</span><br><span class="line"></span><br><span class="line"><span class="comment">// 通用 SQL 查询函数</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">query</span>(<span class="params">sql, params</span>) {</span><br><span class="line">  <span class="keyword">const</span> [results] = <span class="keyword">await</span> pool.<span class="title function_">execute</span>(sql, params);</span><br><span class="line">  <span class="keyword">return</span> results;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// ----------------- 用户增删改查 -----------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取所有用户</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getAllUsers</span>(<span class="params"></span>) {</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">await</span> <span class="title function_">query</span>(<span class="string">'SELECT * FROM users'</span>);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 根据 ID 获取用户</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getUserById</span>(<span class="params">id</span>) {</span><br><span class="line">  <span class="keyword">const</span> results = <span class="keyword">await</span> <span class="title function_">query</span>(<span class="string">'SELECT * FROM users WHERE id = ?'</span>, [id]);</span><br><span class="line">  <span class="keyword">return</span> results[<span class="number">0</span>];</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 新增用户</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">createUser</span>(<span class="params">name, age</span>) {</span><br><span class="line">  <span class="keyword">const</span> result = <span class="keyword">await</span> <span class="title function_">query</span>(<span class="string">'INSERT INTO users (name, age) VALUES (?, ?)'</span>, [name, age]);</span><br><span class="line">  <span class="keyword">return</span> { <span class="attr">id</span>: result.<span class="property">insertId</span>, name, age };</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 更新用户</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">updateUser</span>(<span class="params">id, name, age</span>) {</span><br><span class="line">  <span class="keyword">await</span> <span class="title function_">query</span>(<span class="string">'UPDATE users SET name = ?, age = ? WHERE id = ?'</span>, [name, age, id]);</span><br><span class="line">  <span class="keyword">return</span> { id, name, age };</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 删除用户</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">deleteUser</span>(<span class="params">id</span>) {</span><br><span class="line">  <span class="keyword">const</span> result = <span class="keyword">await</span> <span class="title function_">query</span>(<span class="string">'DELETE FROM users WHERE id = ?'</span>, [id]);</span><br><span class="line">  <span class="keyword">return</span> result.<span class="property">affectedRows</span> &gt; <span class="number">0</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure></h2>
<h2 id="阶段-h重构为-mvcmodel-view-controller分层">8. 阶段 H：重构为
MVC（Model-View-Controller）分层</h2>
<blockquote>
<p>现在把“路由里写业务”的代码拆分：<strong>路由仅负责匹配路径</strong>、<strong>Controller
负责接入/出参与校验</strong>、<strong>Service
负责业务</strong>、<strong>Model
负责数据存储</strong>（此处先用内存/假数据，下一步再换 MySQL）。</p>
</blockquote>
<h3 id="目录调整">8.1 目录调整</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">koa-step-by-step/</span><br><span class="line">├─ app.mjs</span><br><span class="line">├─ routes/</span><br><span class="line">│  ├─ index.mjs</span><br><span class="line">│  └─ users.mjs       # 现在只保留路径定义和与 controller 的绑定</span><br><span class="line">├─ controllers/</span><br><span class="line">│  └─ userController.mjs</span><br><span class="line">├─ services/</span><br><span class="line">│  └─ userService.mjs</span><br><span class="line">├─ models/</span><br><span class="line">│  └─ userModel.mjs   # 此阶段仍用内存数组模拟 DB</span><br><span class="line">└─ public/</span><br></pre></td></tr></table></figure>
<h3 id="modelsusermodel.mjs数据访问层">8.2
<code>models/userModel.mjs</code>（数据访问层）</h3>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// models/userModel.mjs（阶段H - Model 层）</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 此处仍然用内存数组模拟数据库。</span></span><br><span class="line"><span class="comment"> * 下一阶段会把这里的实现换成 MySQL 版本，但对外暴露的方法名尽量保持一致，</span></span><br><span class="line"><span class="comment"> * 这样 Controller/Service 基本不用改动，实现“可替换的数据层”。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> users = [</span><br><span class="line">  { <span class="attr">id</span>: <span class="number">1</span>, <span class="attr">name</span>: <span class="string">'Alice'</span>, <span class="attr">age</span>: <span class="number">20</span> },</span><br><span class="line">  { <span class="attr">id</span>: <span class="number">2</span>, <span class="attr">name</span>: <span class="string">'Bob'</span>,   <span class="attr">age</span>: <span class="number">22</span> }</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">nextId</span> = (<span class="params"></span>) =&gt; (users.<span class="property">length</span> ? users[users.<span class="property">length</span> - <span class="number">1</span>].<span class="property">id</span> + <span class="number">1</span> : <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">findAll</span>(<span class="params"></span>) {</span><br><span class="line">  <span class="keyword">return</span> users;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">findById</span>(<span class="params">id</span>) {</span><br><span class="line">  <span class="keyword">return</span> users.<span class="title function_">find</span>(<span class="function"><span class="params">u</span> =&gt;</span> u.<span class="property">id</span> === id) || <span class="literal">null</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">create</span>(<span class="params">{ name, age }</span>) {</span><br><span class="line">  <span class="keyword">const</span> user = { <span class="attr">id</span>: <span class="title function_">nextId</span>(), name, age };</span><br><span class="line">  users.<span class="title function_">push</span>(user);</span><br><span class="line">  <span class="keyword">return</span> user;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">update</span>(<span class="params">id, { name, age }</span>) {</span><br><span class="line">  <span class="keyword">const</span> idx = users.<span class="title function_">findIndex</span>(<span class="function"><span class="params">u</span> =&gt;</span> u.<span class="property">id</span> === id);</span><br><span class="line">  <span class="keyword">if</span> (idx === -<span class="number">1</span>) <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">  users[idx] = { id, name, age };</span><br><span class="line">  <span class="keyword">return</span> users[idx];</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">patch</span>(<span class="params">id, patchObj</span>) {</span><br><span class="line">  <span class="keyword">const</span> user = users.<span class="title function_">find</span>(<span class="function"><span class="params">u</span> =&gt;</span> u.<span class="property">id</span> === id);</span><br><span class="line">  <span class="keyword">if</span> (!user) <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">  <span class="title class_">Object</span>.<span class="title function_">assign</span>(user, patchObj);</span><br><span class="line">  <span class="keyword">return</span> user;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">remove</span>(<span class="params">id</span>) {</span><br><span class="line">  <span class="keyword">const</span> idx = users.<span class="title function_">findIndex</span>(<span class="function"><span class="params">u</span> =&gt;</span> u.<span class="property">id</span> === id);</span><br><span class="line">  <span class="keyword">if</span> (idx === -<span class="number">1</span>) <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">return</span> users.<span class="title function_">splice</span>(idx, <span class="number">1</span>)[<span class="number">0</span>];</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>直接调用数据库增删改查函数，但保持原来的 RESTful API 路由结构：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// routes/users.mjs（阶段G -&gt; 数据库版）</span></span><br><span class="line"><span class="comment">// 目标：实现 RESTful 风格的用户资源接口，直接操作 MySQL 数据库</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Router</span> <span class="keyword">from</span> <span class="string">'koa-router'</span>;</span><br><span class="line"><span class="comment">// 从 mysqldb.mjs 导入封装好的增删改查函数</span></span><br><span class="line"><span class="keyword">import</span> { getAllUsers, getUserById, createUser, updateUser, deleteUser } <span class="keyword">from</span> <span class="string">'../database/mysqldb.mjs'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> router = <span class="keyword">new</span> <span class="title class_">Router</span>({ <span class="attr">prefix</span>: <span class="string">'/api/users'</span> });</span><br><span class="line"></span><br><span class="line"><span class="comment">// ----------------- RESTful 路由 -----------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// GET /api/users  -&gt; 获取用户列表</span></span><br><span class="line">router.<span class="title function_">get</span>(<span class="string">'/'</span>, <span class="title function_">async</span> (ctx) =&gt; {</span><br><span class="line">  <span class="keyword">try</span> {</span><br><span class="line">    <span class="keyword">const</span> users = <span class="keyword">await</span> <span class="title function_">getAllUsers</span>(); <span class="comment">// 调用数据库查询所有用户</span></span><br><span class="line">    ctx.<span class="property">status</span> = <span class="number">200</span>;</span><br><span class="line">    ctx.<span class="property">body</span> = { <span class="attr">code</span>: <span class="number">200</span>, <span class="attr">data</span>: users };</span><br><span class="line">  } <span class="keyword">catch</span> (err) {</span><br><span class="line">    ctx.<span class="keyword">throw</span>(<span class="number">500</span>, err.<span class="property">message</span>);</span><br><span class="line">  }</span><br><span class="line">});</span><br><span class="line"></span><br><span class="line"><span class="comment">// GET /api/users/:id  -&gt; 根据 ID 获取用户详情</span></span><br><span class="line">router.<span class="title function_">get</span>(<span class="string">'/:id'</span>, <span class="title function_">async</span> (ctx) =&gt; {</span><br><span class="line">  <span class="keyword">const</span> id = <span class="title class_">Number</span>(ctx.<span class="property">params</span>.<span class="property">id</span>);</span><br><span class="line">  <span class="keyword">try</span> {</span><br><span class="line">    <span class="keyword">const</span> user = <span class="keyword">await</span> <span class="title function_">getUserById</span>(id); <span class="comment">// 调用数据库查询单个用户</span></span><br><span class="line">    <span class="keyword">if</span> (!user) {</span><br><span class="line">      ctx.<span class="keyword">throw</span>(<span class="number">404</span>, <span class="string">`用户 <span class="subst">${id}</span> 不存在`</span>);</span><br><span class="line">    }</span><br><span class="line">    ctx.<span class="property">status</span> = <span class="number">200</span>;</span><br><span class="line">    ctx.<span class="property">body</span> = { <span class="attr">code</span>: <span class="number">200</span>, <span class="attr">data</span>: user };</span><br><span class="line">  } <span class="keyword">catch</span> (err) {</span><br><span class="line">    ctx.<span class="keyword">throw</span>(<span class="number">500</span>, err.<span class="property">message</span>);</span><br><span class="line">  }</span><br><span class="line">});</span><br><span class="line"></span><br><span class="line"><span class="comment">// POST /api/users  -&gt; 新增用户</span></span><br><span class="line">router.<span class="title function_">post</span>(<span class="string">'/'</span>, <span class="title function_">async</span> (ctx) =&gt; {</span><br><span class="line">  <span class="keyword">const</span> { name, age } = ctx.<span class="property">request</span>.<span class="property">body</span> || {};</span><br><span class="line">  <span class="keyword">if</span> (!name || <span class="keyword">typeof</span> age !== <span class="string">'number'</span>) {</span><br><span class="line">    ctx.<span class="keyword">throw</span>(<span class="number">400</span>, <span class="string">'参数不合法：需要 name(string) 与 age(number)'</span>);</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">try</span> {</span><br><span class="line">    <span class="keyword">const</span> newUser = <span class="keyword">await</span> <span class="title function_">createUser</span>(name, age); <span class="comment">// 调用数据库新增用户</span></span><br><span class="line">    ctx.<span class="property">status</span> = <span class="number">201</span>; <span class="comment">// 201：已创建</span></span><br><span class="line">    ctx.<span class="property">body</span> = { <span class="attr">code</span>: <span class="number">201</span>, <span class="attr">data</span>: newUser };</span><br><span class="line">  } <span class="keyword">catch</span> (err) {</span><br><span class="line">    ctx.<span class="keyword">throw</span>(<span class="number">500</span>, err.<span class="property">message</span>);</span><br><span class="line">  }</span><br><span class="line">});</span><br><span class="line"></span><br><span class="line"><span class="comment">// PUT /api/users/:id  -&gt; 全量更新用户</span></span><br><span class="line">router.<span class="title function_">put</span>(<span class="string">'/:id'</span>, <span class="title function_">async</span> (ctx) =&gt; {</span><br><span class="line">  <span class="keyword">const</span> id = <span class="title class_">Number</span>(ctx.<span class="property">params</span>.<span class="property">id</span>);</span><br><span class="line">  <span class="keyword">const</span> { name, age } = ctx.<span class="property">request</span>.<span class="property">body</span> || {};</span><br><span class="line">  <span class="keyword">if</span> (!name || <span class="keyword">typeof</span> age !== <span class="string">'number'</span>) {</span><br><span class="line">    ctx.<span class="keyword">throw</span>(<span class="number">400</span>, <span class="string">'参数不合法：需要 name(string) 与 age(number)'</span>);</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">try</span> {</span><br><span class="line">    <span class="keyword">const</span> updatedUser = <span class="keyword">await</span> <span class="title function_">updateUser</span>(id, name, age); <span class="comment">// 调用数据库更新</span></span><br><span class="line">    ctx.<span class="property">status</span> = <span class="number">200</span>;</span><br><span class="line">    ctx.<span class="property">body</span> = { <span class="attr">code</span>: <span class="number">200</span>, <span class="attr">data</span>: updatedUser };</span><br><span class="line">  } <span class="keyword">catch</span> (err) {</span><br><span class="line">    ctx.<span class="keyword">throw</span>(<span class="number">500</span>, err.<span class="property">message</span>);</span><br><span class="line">  }</span><br><span class="line">});</span><br><span class="line"></span><br><span class="line"><span class="comment">// PATCH /api/users/:id  -&gt; 部分更新用户</span></span><br><span class="line">router.<span class="title function_">patch</span>(<span class="string">'/:id'</span>, <span class="title function_">async</span> (ctx) =&gt; {</span><br><span class="line">  <span class="keyword">const</span> id = <span class="title class_">Number</span>(ctx.<span class="property">params</span>.<span class="property">id</span>);</span><br><span class="line">  <span class="keyword">const</span> patch = ctx.<span class="property">request</span>.<span class="property">body</span> || {};</span><br><span class="line">  <span class="keyword">try</span> {</span><br><span class="line">    <span class="keyword">const</span> existingUser = <span class="keyword">await</span> <span class="title function_">getUserById</span>(id);</span><br><span class="line">    <span class="keyword">if</span> (!existingUser) ctx.<span class="keyword">throw</span>(<span class="number">404</span>, <span class="string">`用户 <span class="subst">${id}</span> 不存在`</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 合并已有数据与更新数据</span></span><br><span class="line">    <span class="keyword">const</span> updatedUser = <span class="keyword">await</span> <span class="title function_">updateUser</span>(id, patch.<span class="property">name</span> ?? existingUser.<span class="property">name</span>, patch.<span class="property">age</span> ?? existingUser.<span class="property">age</span>);</span><br><span class="line">    ctx.<span class="property">status</span> = <span class="number">200</span>;</span><br><span class="line">    ctx.<span class="property">body</span> = { <span class="attr">code</span>: <span class="number">200</span>, <span class="attr">data</span>: updatedUser };</span><br><span class="line">  } <span class="keyword">catch</span> (err) {</span><br><span class="line">    ctx.<span class="keyword">throw</span>(<span class="number">500</span>, err.<span class="property">message</span>);</span><br><span class="line">  }</span><br><span class="line">});</span><br><span class="line"></span><br><span class="line"><span class="comment">// DELETE /api/users/:id  -&gt; 删除用户</span></span><br><span class="line">router.<span class="title function_">delete</span>(<span class="string">'/:id'</span>, <span class="title function_">async</span> (ctx) =&gt; {</span><br><span class="line">  <span class="keyword">const</span> id = <span class="title class_">Number</span>(ctx.<span class="property">params</span>.<span class="property">id</span>);</span><br><span class="line">  <span class="keyword">try</span> {</span><br><span class="line">    <span class="keyword">const</span> success = <span class="keyword">await</span> <span class="title function_">deleteUser</span>(id);</span><br><span class="line">    <span class="keyword">if</span> (!success) ctx.<span class="keyword">throw</span>(<span class="number">404</span>, <span class="string">`用户 <span class="subst">${id}</span> 不存在`</span>);</span><br><span class="line">    ctx.<span class="property">status</span> = <span class="number">200</span>;</span><br><span class="line">    ctx.<span class="property">body</span> = { <span class="attr">code</span>: <span class="number">200</span>, <span class="attr">message</span>: <span class="string">`用户 <span class="subst">${id}</span> 已删除`</span> };</span><br><span class="line">  } <span class="keyword">catch</span> (err) {</span><br><span class="line">    ctx.<span class="keyword">throw</span>(<span class="number">500</span>, err.<span class="property">message</span>);</span><br><span class="line">  }</span><br><span class="line">});</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> router;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="servicesuserservice.mjs业务层">8.3
<code>services/userService.mjs</code>（业务层）</h3>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// services/userService.mjs（阶段H - Service 层）</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 业务层：进行业务规则校验（示例简单化），</span></span><br><span class="line"><span class="comment"> * 将 Controller 的输入转为 Model 层所需格式；</span></span><br><span class="line"><span class="comment"> * 对 Model 输出进行二次处理（如脱敏、聚合等）。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> <span class="title class_">User</span> <span class="keyword">from</span> <span class="string">'../models/userModel.mjs'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">listUsers</span>(<span class="params"></span>) {</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">await</span> <span class="title class_">User</span>.<span class="title function_">findAll</span>();</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getUser</span>(<span class="params">id</span>) {</span><br><span class="line">  <span class="keyword">const</span> user = <span class="keyword">await</span> <span class="title class_">User</span>.<span class="title function_">findById</span>(id);</span><br><span class="line">  <span class="keyword">return</span> user; <span class="comment">// 可添加“脱敏”等处理</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">createUser</span>(<span class="params">{ name, age }</span>) {</span><br><span class="line">  <span class="keyword">if</span> (!name || <span class="keyword">typeof</span> age !== <span class="string">'number'</span>) {</span><br><span class="line">    <span class="keyword">const</span> err = <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">'参数不合法：需要 name(string) 与 age(number)'</span>);</span><br><span class="line">    err.<span class="property">status</span> = <span class="number">400</span>;</span><br><span class="line">    <span class="keyword">throw</span> err;</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">await</span> <span class="title class_">User</span>.<span class="title function_">create</span>({ name, age });</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">updateUser</span>(<span class="params">id, { name, age }</span>) {</span><br><span class="line">  <span class="keyword">if</span> (!name || <span class="keyword">typeof</span> age !== <span class="string">'number'</span>) {</span><br><span class="line">    <span class="keyword">const</span> err = <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">'参数不合法：需要 name 与 age'</span>);</span><br><span class="line">    err.<span class="property">status</span> = <span class="number">400</span>;</span><br><span class="line">    <span class="keyword">throw</span> err;</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">const</span> updated = <span class="keyword">await</span> <span class="title class_">User</span>.<span class="title function_">update</span>(id, { name, age });</span><br><span class="line">  <span class="keyword">if</span> (!updated) {</span><br><span class="line">    <span class="keyword">const</span> err = <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">`用户 <span class="subst">${id}</span> 不存在`</span>);</span><br><span class="line">    err.<span class="property">status</span> = <span class="number">404</span>;</span><br><span class="line">    <span class="keyword">throw</span> err;</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">return</span> updated;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">patchUser</span>(<span class="params">id, patchObj</span>) {</span><br><span class="line">  <span class="keyword">const</span> updated = <span class="keyword">await</span> <span class="title class_">User</span>.<span class="title function_">patch</span>(id, patchObj);</span><br><span class="line">  <span class="keyword">if</span> (!updated) {</span><br><span class="line">    <span class="keyword">const</span> err = <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">`用户 <span class="subst">${id}</span> 不存在`</span>);</span><br><span class="line">    err.<span class="property">status</span> = <span class="number">404</span>;</span><br><span class="line">    <span class="keyword">throw</span> err;</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">return</span> updated;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">removeUser</span>(<span class="params">id</span>) {</span><br><span class="line">  <span class="keyword">const</span> deleted = <span class="keyword">await</span> <span class="title class_">User</span>.<span class="title function_">remove</span>(id);</span><br><span class="line">  <span class="keyword">if</span> (!deleted) {</span><br><span class="line">    <span class="keyword">const</span> err = <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">`用户 <span class="subst">${id}</span> 不存在`</span>);</span><br><span class="line">    err.<span class="property">status</span> = <span class="number">404</span>;</span><br><span class="line">    <span class="keyword">throw</span> err;</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">return</span> deleted;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<h3 id="controllersusercontroller.mjs控制器层">8.4
<code>controllers/userController.mjs</code>（控制器层）</h3>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// controllers/userController.mjs（阶段H - Controller 层）</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 控制器：仅负责与 Koa 的 ctx 交互（取参、设响应、设状态码）。</span></span><br><span class="line"><span class="comment"> * 真正的业务逻辑不写在这里，全部委托给 Service。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> <span class="title class_">UserService</span> <span class="keyword">from</span> <span class="string">'../services/userService.mjs'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">list</span>(<span class="params">ctx</span>) {</span><br><span class="line">  <span class="keyword">const</span> data = <span class="keyword">await</span> <span class="title class_">UserService</span>.<span class="title function_">listUsers</span>();</span><br><span class="line">  ctx.<span class="property">status</span> = <span class="number">200</span>;</span><br><span class="line">  ctx.<span class="property">body</span> = { <span class="attr">code</span>: <span class="number">200</span>, data };</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">detail</span>(<span class="params">ctx</span>) {</span><br><span class="line">  <span class="keyword">const</span> id = <span class="title class_">Number</span>(ctx.<span class="property">params</span>.<span class="property">id</span>);</span><br><span class="line">  <span class="keyword">const</span> data = <span class="keyword">await</span> <span class="title class_">UserService</span>.<span class="title function_">getUser</span>(id);</span><br><span class="line">  <span class="keyword">if</span> (!data) {</span><br><span class="line">    ctx.<span class="keyword">throw</span>(<span class="number">404</span>, <span class="string">`用户 <span class="subst">${id}</span> 不存在`</span>);</span><br><span class="line">  }</span><br><span class="line">  ctx.<span class="property">body</span> = { <span class="attr">code</span>: <span class="number">200</span>, data };</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">create</span>(<span class="params">ctx</span>) {</span><br><span class="line">  <span class="keyword">const</span> { name, age } = ctx.<span class="property">request</span>.<span class="property">body</span> || {};</span><br><span class="line">  <span class="keyword">const</span> data = <span class="keyword">await</span> <span class="title class_">UserService</span>.<span class="title function_">createUser</span>({ name, age });</span><br><span class="line">  ctx.<span class="property">status</span> = <span class="number">201</span>;</span><br><span class="line">  ctx.<span class="property">body</span> = { <span class="attr">code</span>: <span class="number">201</span>, data };</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">update</span>(<span class="params">ctx</span>) {</span><br><span class="line">  <span class="keyword">const</span> id = <span class="title class_">Number</span>(ctx.<span class="property">params</span>.<span class="property">id</span>);</span><br><span class="line">  <span class="keyword">const</span> { name, age } = ctx.<span class="property">request</span>.<span class="property">body</span> || {};</span><br><span class="line">  <span class="keyword">const</span> data = <span class="keyword">await</span> <span class="title class_">UserService</span>.<span class="title function_">updateUser</span>(id, { name, age });</span><br><span class="line">  ctx.<span class="property">body</span> = { <span class="attr">code</span>: <span class="number">200</span>, data };</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">patch</span>(<span class="params">ctx</span>) {</span><br><span class="line">  <span class="keyword">const</span> id = <span class="title class_">Number</span>(ctx.<span class="property">params</span>.<span class="property">id</span>);</span><br><span class="line">  <span class="keyword">const</span> patchObj = ctx.<span class="property">request</span>.<span class="property">body</span> || {};</span><br><span class="line">  <span class="keyword">const</span> data = <span class="keyword">await</span> <span class="title class_">UserService</span>.<span class="title function_">patchUser</span>(id, patchObj);</span><br><span class="line">  ctx.<span class="property">body</span> = { <span class="attr">code</span>: <span class="number">200</span>, data };</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">remove</span>(<span class="params">ctx</span>) {</span><br><span class="line">  <span class="keyword">const</span> id = <span class="title class_">Number</span>(ctx.<span class="property">params</span>.<span class="property">id</span>);</span><br><span class="line">  <span class="keyword">const</span> data = <span class="keyword">await</span> <span class="title class_">UserService</span>.<span class="title function_">removeUser</span>(id);</span><br><span class="line">  ctx.<span class="property">body</span> = { <span class="attr">code</span>: <span class="number">200</span>, data };</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<h3 id="routesusers.mjs只负责绑定路径到-controller">8.5
<code>routes/users.mjs</code>（只负责绑定路径到 Controller）</h3>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// routes/users.mjs（阶段H）</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Router</span> <span class="keyword">from</span> <span class="string">'koa-router'</span>;</span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> <span class="title class_">UserController</span> <span class="keyword">from</span> <span class="string">'../controllers/userController.mjs'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> router = <span class="keyword">new</span> <span class="title class_">Router</span>({ <span class="attr">prefix</span>: <span class="string">'/api/users'</span> });</span><br><span class="line"></span><br><span class="line">router.<span class="title function_">get</span>(<span class="string">'/'</span>,     <span class="title class_">UserController</span>.<span class="property">list</span>);</span><br><span class="line">router.<span class="title function_">get</span>(<span class="string">'/:id'</span>,  <span class="title class_">UserController</span>.<span class="property">detail</span>);</span><br><span class="line">router.<span class="title function_">post</span>(<span class="string">'/'</span>,    <span class="title class_">UserController</span>.<span class="property">create</span>);</span><br><span class="line">router.<span class="title function_">put</span>(<span class="string">'/:id'</span>,  <span class="title class_">UserController</span>.<span class="property">update</span>);</span><br><span class="line">router.<span class="title function_">patch</span>(<span class="string">'/:id'</span>,<span class="title class_">UserController</span>.<span class="property">patch</span>);</span><br><span class="line">router.<span class="title function_">delete</span>(<span class="string">'/:id'</span>, <span class="title class_">UserController</span>.<span class="property">remove</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> router;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>至此，已经是一个<strong>结构清晰</strong>的 REST +
MVC（无数据库版）。</p>
</blockquote>
<hr>
<h2 id="阶段-i把-model-换成-mysqlmysql2promise-连接池">9. 阶段 I：把
Model 换成 MySQL（mysql2/promise + 连接池）</h2>
<h3 id="安装依赖-1">9.1 安装依赖</h3>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i mysql2 dotenv</span><br></pre></td></tr></table></figure>
<h3 id="新增-databasemysql.mjs连接池与-query-封装">9.2 新增
<code>database/mysql.mjs</code>（连接池与 query 封装）</h3>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// database/mysql.mjs（阶段I - 数据库基础封装）</span></span><br><span class="line"><span class="keyword">import</span> mysql <span class="keyword">from</span> <span class="string">'mysql2/promise'</span>;</span><br><span class="line"><span class="keyword">import</span> dotenv <span class="keyword">from</span> <span class="string">'dotenv'</span>;</span><br><span class="line"></span><br><span class="line">dotenv.<span class="title function_">config</span>(); <span class="comment">// 读取 .env</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建连接池（推荐生产环境使用连接池，而非单连接）</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> pool = mysql.<span class="title function_">createPool</span>({</span><br><span class="line">  <span class="attr">host</span>:     process.<span class="property">env</span>.<span class="property">DB_HOST</span> || <span class="string">'localhost'</span>,</span><br><span class="line">  <span class="attr">user</span>:     process.<span class="property">env</span>.<span class="property">DB_USER</span> || <span class="string">'root'</span>,</span><br><span class="line">  <span class="attr">password</span>: process.<span class="property">env</span>.<span class="property">DB_PASSWORD</span> || <span class="string">'123456'</span>,</span><br><span class="line">  <span class="attr">database</span>: process.<span class="property">env</span>.<span class="property">DB_NAME</span> || <span class="string">'testdb'</span>,</span><br><span class="line">  <span class="attr">port</span>:     <span class="title class_">Number</span>(process.<span class="property">env</span>.<span class="property">DB_PORT</span> || <span class="number">3306</span>),</span><br><span class="line">  <span class="attr">waitForConnections</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">connectionLimit</span>: <span class="number">10</span>,</span><br><span class="line">  <span class="attr">queueLimit</span>: <span class="number">0</span></span><br><span class="line">});</span><br><span class="line"></span><br><span class="line"><span class="comment">// 统一的 SQL 执行函数：自动格式化参数，返回 rows</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">query</span>(<span class="params">sql, params = []</span>) {</span><br><span class="line">  <span class="keyword">const</span> [rows] = <span class="keyword">await</span> pool.<span class="title function_">execute</span>(sql, params);</span><br><span class="line">  <span class="keyword">return</span> rows;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<h3 id="在项目根目录创建-.env">9.3 在项目根目录创建
<code>.env</code></h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">DB_HOST=localhost</span><br><span class="line">DB_PORT=3306</span><br><span class="line">DB_USER=root</span><br><span class="line">DB_PASSWORD=123456</span><br><span class="line">DB_NAME=testdb</span><br></pre></td></tr></table></figure>
<h3 id="初始化数据表一次性">9.4 初始化数据表（一次性）</h3>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE TABLE</span> IF <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> users (</span><br><span class="line">  id   <span class="type">INT</span> AUTO_INCREMENT <span class="keyword">PRIMARY KEY</span>,</span><br><span class="line">  name <span class="type">VARCHAR</span>(<span class="number">50</span>) <span class="keyword">NOT NULL</span>,</span><br><span class="line">  age  <span class="type">INT</span> <span class="keyword">NOT NULL</span>,</span><br><span class="line">  created_at <span class="type">TIMESTAMP</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<h3 id="重写-modelsusermodel.mjs-为-mysql-实现">9.5 重写
<code>models/userModel.mjs</code> 为 MySQL 实现</h3>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// models/userModel.mjs（阶段I - MySQL 版本 Model 层）</span></span><br><span class="line"><span class="keyword">import</span> { query } <span class="keyword">from</span> <span class="string">'../database/mysql.mjs'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">findAll</span>(<span class="params"></span>) {</span><br><span class="line">  <span class="comment">// 返回全部用户</span></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">await</span> <span class="title function_">query</span>(<span class="string">'SELECT id, name, age, created_at FROM users ORDER BY id ASC'</span>);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">findById</span>(<span class="params">id</span>) {</span><br><span class="line">  <span class="keyword">const</span> rows = <span class="keyword">await</span> <span class="title function_">query</span>(<span class="string">'SELECT id, name, age, created_at FROM users WHERE id = ?'</span>, [id]);</span><br><span class="line">  <span class="keyword">return</span> rows[<span class="number">0</span>] || <span class="literal">null</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">create</span>(<span class="params">{ name, age }</span>) {</span><br><span class="line">  <span class="comment">// 使用 ? 占位符防止 SQL 注入</span></span><br><span class="line">  <span class="keyword">const</span> result = <span class="keyword">await</span> <span class="title function_">query</span>(<span class="string">'INSERT INTO users (name, age) VALUES (?, ?)'</span>, [name, age]);</span><br><span class="line">  <span class="comment">// 插入成功后返回新记录</span></span><br><span class="line">  <span class="keyword">const</span> inserted = <span class="keyword">await</span> <span class="title function_">findById</span>(result.<span class="property">insertId</span>);</span><br><span class="line">  <span class="keyword">return</span> inserted;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">update</span>(<span class="params">id, { name, age }</span>) {</span><br><span class="line">  <span class="keyword">const</span> result = <span class="keyword">await</span> <span class="title function_">query</span>(<span class="string">'UPDATE users SET name = ?, age = ? WHERE id = ?'</span>, [name, age, id]);</span><br><span class="line">  <span class="keyword">if</span> (result.<span class="property">affectedRows</span> === <span class="number">0</span>) <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">await</span> <span class="title function_">findById</span>(id);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">patch</span>(<span class="params">id, patchObj</span>) {</span><br><span class="line">  <span class="comment">// 动态拼接字段（示例简化，仅允许 name/age）</span></span><br><span class="line">  <span class="keyword">const</span> fields = [];</span><br><span class="line">  <span class="keyword">const</span> params = [];</span><br><span class="line">  <span class="keyword">if</span> (patchObj.<span class="property">name</span> !== <span class="literal">undefined</span>) { fields.<span class="title function_">push</span>(<span class="string">'name = ?'</span>); params.<span class="title function_">push</span>(patchObj.<span class="property">name</span>); }</span><br><span class="line">  <span class="keyword">if</span> (patchObj.<span class="property">age</span> !== <span class="literal">undefined</span>)  { fields.<span class="title function_">push</span>(<span class="string">'age = ?'</span>);  params.<span class="title function_">push</span>(patchObj.<span class="property">age</span>); }</span><br><span class="line">  <span class="keyword">if</span> (fields.<span class="property">length</span> === <span class="number">0</span>) <span class="keyword">return</span> <span class="keyword">await</span> <span class="title function_">findById</span>(id); <span class="comment">// 无变化</span></span><br><span class="line">  params.<span class="title function_">push</span>(id);</span><br><span class="line">  <span class="keyword">const</span> sql = <span class="string">`UPDATE users SET <span class="subst">${fields.join(<span class="string">', '</span>)}</span> WHERE id = ?`</span>;</span><br><span class="line">  <span class="keyword">const</span> result = <span class="keyword">await</span> <span class="title function_">query</span>(sql, params);</span><br><span class="line">  <span class="keyword">if</span> (result.<span class="property">affectedRows</span> === <span class="number">0</span>) <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">await</span> <span class="title function_">findById</span>(id);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">remove</span>(<span class="params">id</span>) {</span><br><span class="line">  <span class="keyword">const</span> toDelete = <span class="keyword">await</span> <span class="title function_">findById</span>(id);</span><br><span class="line">  <span class="keyword">if</span> (!toDelete) <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">const</span> result = <span class="keyword">await</span> <span class="title function_">query</span>(<span class="string">'DELETE FROM users WHERE id = ?'</span>, [id]);</span><br><span class="line">  <span class="keyword">if</span> (result.<span class="property">affectedRows</span> === <span class="number">0</span>) <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">return</span> toDelete;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>无感替换数据层</strong>：我们没有改 Controller/Service
的代码，因为它们的调用接口未变。这就是解耦的好处。</p>
</blockquote>
<h3 id="运行与测试">9.6 运行与测试</h3>
<ol type="1">
<li>确认本机 MySQL 已启动，并在 <code>.env</code> 中配置正确；</li>
<li>执行上面的建表 SQL；</li>
<li>启动服务：<code>npm run dev</code>；</li>
<li>使用前文的 <code>curl</code> 测试 CRUD 接口；现在数据真实写入
MySQL！</li>
</ol>
<hr>
<h2 id="阶段-j额外增强可选但常用">10. 阶段
J：额外增强（可选但常用）</h2>
<h3 id="cors跨域">10.1 CORS（跨域）</h3>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i @koa/cors</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> cors <span class="keyword">from</span> <span class="string">'@koa/cors'</span>;</span><br><span class="line">app.<span class="title function_">use</span>(<span class="title function_">cors</span>({ <span class="attr">origin</span>: <span class="string">'*'</span> })); <span class="comment">// 生产建议更精细控制</span></span><br></pre></td></tr></table></figure>
<h3 id="请求参数校验轻量示例">10.2 请求参数校验（轻量示例）</h3>
<blockquote>
<p>在 Service 层已经有简单校验；进一步可以使用 <code>zod</code>,
<code>joi</code>, <code>yup</code> 等库统一校验。</p>
</blockquote>
<h3 id="分页-模糊查询以-mysql-为例改造-model">10.3 分页 &amp;
模糊查询（以 MySQL 为例，改造 Model）</h3>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 示例：分页查询（page 从 1 开始）</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">findPaged</span>(<span class="params">{ page = <span class="number">1</span>, pageSize = <span class="number">10</span>, keyword = <span class="string">''</span> }</span>) {</span><br><span class="line">  <span class="keyword">const</span> offset = (page - <span class="number">1</span>) * pageSize;</span><br><span class="line">  <span class="keyword">const</span> where  = keyword ? <span class="string">'WHERE name LIKE ?'</span> : <span class="string">''</span>;</span><br><span class="line">  <span class="keyword">const</span> params = keyword ? [<span class="string">`%<span class="subst">${keyword}</span>%`</span>, pageSize, offset] : [pageSize, offset];</span><br><span class="line">  <span class="keyword">const</span> rows   = <span class="keyword">await</span> <span class="title function_">query</span>(</span><br><span class="line">    <span class="string">`SELECT id, name, age, created_at FROM users <span class="subst">${where}</span> ORDER BY id ASC LIMIT ? OFFSET ?`</span>,</span><br><span class="line">    params</span><br><span class="line">  );</span><br><span class="line">  <span class="keyword">const</span> totalRows = <span class="keyword">await</span> <span class="title function_">query</span>(</span><br><span class="line">    <span class="string">`SELECT COUNT(*) AS c FROM users <span class="subst">${keyword ? <span class="string">'WHERE name LIKE ?'</span> : <span class="string">''</span>}</span>`</span>,</span><br><span class="line">    keyword ? [<span class="string">`%<span class="subst">${keyword}</span>%`</span>] : []</span><br><span class="line">  );</span><br><span class="line">  <span class="keyword">return</span> { <span class="attr">list</span>: rows, <span class="attr">total</span>: totalRows[<span class="number">0</span>].<span class="property">c</span>, page, pageSize };</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="常见坑位排查faq">11. 常见坑位排查（FAQ）</h2>
<ul>
<li><strong><code>SyntaxError: Cannot use import statement outside a module</code></strong>
<ul>
<li><code>package.json</code> 是否含
<code>"type":"module"</code>？或者文件是否使用 <code>.mjs</code>？</li>
</ul></li>
<li><strong><code>Error: Cannot find module 'xxx'</code></strong>
<ul>
<li>依赖没装或装在了错误目录：执行
<code>npm i xxx</code>，确保命令行的当前目录正确。</li>
</ul></li>
<li><strong><code>ctx.request.body</code> 是
<code>undefined</code></strong>
<ul>
<li>是否 <code>app.use(bodyParser())</code>
放在了路由前面？是否设置了正确的 <code>Content-Type</code>？</li>
</ul></li>
<li><strong>中文乱码</strong>
<ul>
<li>前端/客户端请求与响应头编码问题；确保响应头
<code>Content-Type</code> 与实际内容一致（Koa 会自动根据
<code>ctx.body</code> 设定）。</li>
</ul></li>
<li><strong>MySQL 连接失败</strong>
<ul>
<li>检查 <code>.env</code>
配置、数据库是否启动、端口是否被占用、防火墙、权限是否允许远程连接。</li>
</ul></li>
</ul>
<hr>
<h2 id="最终项目结构参考到阶段-i-为止">12. 最终项目结构参考（到阶段 I
为止）</h2>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">koa-step-by-step/</span><br><span class="line">├─ app.mjs</span><br><span class="line">├─ public/</span><br><span class="line">│  └─ index.html</span><br><span class="line">├─ views/                # 若使用模板渲染</span><br><span class="line">│  └─ home.ejs</span><br><span class="line">├─ routes/</span><br><span class="line">│  ├─ index.mjs</span><br><span class="line">│  ├─ users.mjs</span><br><span class="line">├─ controllers/</span><br><span class="line">│  └─ userController.mjs</span><br><span class="line">├─ services/</span><br><span class="line">│  └─ userService.mjs</span><br><span class="line">├─ models/</span><br><span class="line">│  └─ userModel.mjs      # 阶段H：内存; 阶段I：MySQL</span><br><span class="line">├─ database/</span><br><span class="line">│  └─ mysql.mjs</span><br><span class="line">├─ .env</span><br><span class="line">└─ package.json</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="一句话回顾每个阶段">13. 一句话回顾每个阶段</h2>
<ul>
<li><strong>A</strong>：只有一个文件的“Hello Koa”</li>
<li><strong>B</strong>：加上
<code>koa-router</code>，不同路径返回不同内容</li>
<li><strong>C</strong>：解析请求体，拥有第一个 POST 接口</li>
<li><strong>D</strong>：全局错误处理 + 访问日志，理解“洋葱模型”</li>
<li><strong>E</strong>：静态资源与 favicon</li>
<li><strong>F</strong>：（可选）EJS 模板渲染</li>
<li><strong>G</strong>：RESTful 内存版 users 资源（CRUD）</li>
<li><strong>H</strong>：重构为 MVC（Controller/Service/Model 分层）</li>
<li><strong>I</strong>：替换 Model → MySQL（真实落库）</li>
<li><strong>J</strong>：加强：CORS、校验、分页等</li>
</ul>

    </div>

    
    
    
    
      <div>
        <div>
    
        <div style="text-align:center;color: #ccc;font-size:14px;">~~~~~~~~~~~~~~ 本文结束 <i class="fa fa-paw"></i> 感谢您的阅读 ~~~~~~~~~~~~~~</div>
    
</div>
      </div>
    
        <div class="reward-container">
  <div>在线要饭~</div>
  <button onclick="var qr = document.getElementById('qr'); qr.style.display = (qr.style.display === 'none') ? 'block' : 'none';">
    Donate
  </button>
  <div id="qr" style="display: none;">
      
      <div style="display: inline-block;">
        <img src="/images/wechatpay.JPG" alt="koen WeChat Pay">
        <p>WeChat Pay</p>
      </div>

  </div>
</div>


      <footer class="post-footer">
          
          <div class="post-tags">
              <a href="/tags/Koa/" rel="tag"><i class="fa fa-tag"></i> Koa</a>
              <a href="/tags/backen/" rel="tag"><i class="fa fa-tag"></i> backen</a>
              <a href="/tags/nodejs/" rel="tag"><i class="fa fa-tag"></i> nodejs</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2025/08/18/latex_2/" rel="prev" title="Latex全语法使用">
      <i class="fa fa-chevron-left"></i> Latex全语法使用
    </a></div>
      <div class="post-nav-item">
    <a href="/2025/09/01/sql/" rel="next" title="SQL语法规则">
      SQL语法规则 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
    <div class="comments" id="gitalk-container"></div>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C"><span class="nav-text">0. 准备工作</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%89%E8%A3%85-node.js%E5%BB%BA%E8%AE%AE-node-18"><span class="nav-text">0.1 安装 Node.js（建议 Node 18+）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%96%B0%E5%BB%BA%E9%A1%B9%E7%9B%AE%E7%9B%AE%E5%BD%95%E5%B9%B6%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="nav-text">0.2 新建项目目录并初始化</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#esm-%E8%AE%BE%E7%BD%AE%E5%BC%BA%E7%83%88%E5%BB%BA%E8%AE%AE"><span class="nav-text">0.3 ESM 设置（强烈建议）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8E%A8%E8%8D%90%E6%9C%AC%E5%9C%B0%E5%BC%80%E5%8F%91%E8%84%9A%E6%9C%AC%E5%8F%AF%E7%83%AD%E9%87%8D%E8%BD%BD"><span class="nav-text">0.4 推荐本地开发脚本（可热重载）</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%98%B6%E6%AE%B5-a%E6%9C%80%E5%B0%8F%E5%8F%AF%E8%BF%90%E8%A1%8C%E7%9A%84-koa%E6%97%A0%E8%B7%AF%E7%94%B1%E6%97%A0%E4%B8%AD%E9%97%B4%E4%BB%B6%E6%A0%88"><span class="nav-text">1. 阶段 A：最小可运行的
Koa（无路由、无中间件栈）</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%89%E8%A3%85-koa"><span class="nav-text">1.1 安装 Koa</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%96%B0%E5%BB%BA-app.mjs"><span class="nav-text">1.2 新建 app.mjs</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%BF%90%E8%A1%8C"><span class="nav-text">1.3 运行</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%98%B6%E6%AE%B5-b%E5%BC%95%E5%85%A5%E8%B7%AF%E7%94%B1koa-router%E8%AE%A9%E4%B8%8D%E5%90%8C%E8%B7%AF%E5%BE%84%E8%B5%B0%E4%B8%8D%E5%90%8C%E9%80%BB%E8%BE%91"><span class="nav-text">2. 阶段
B：引入路由（koa-router），让不同路径走不同逻辑</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%89%E8%A3%85%E8%B7%AF%E7%94%B1%E4%B8%AD%E9%97%B4%E4%BB%B6"><span class="nav-text">2.1 安装路由中间件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%96%B0%E5%BB%BA-routesindex.mjs"><span class="nav-text">2.2 新建
routes&#x2F;index.mjs</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BF%AE%E6%94%B9-app.mjs-%E4%BD%BF%E7%94%A8%E8%B7%AF%E7%94%B1"><span class="nav-text">2.3 修改 app.mjs
使用路由</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%98%B6%E6%AE%B5-c%E8%A7%A3%E6%9E%90%E8%AF%B7%E6%B1%82%E4%BD%93koa-bodyparser%E5%B9%B6%E5%AE%9E%E7%8E%B0%E7%AC%AC%E4%B8%80%E4%B8%AA-post-api"><span class="nav-text">3. 阶段
C：解析请求体（koa-bodyparser）并实现第一个 POST API</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%89%E8%A3%85-body-%E8%A7%A3%E6%9E%90%E4%B8%AD%E9%97%B4%E4%BB%B6"><span class="nav-text">3.1 安装 body 解析中间件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9C%A8-app.mjs-%E5%90%AF%E7%94%A8-bodyparser"><span class="nav-text">3.2 在 app.mjs 启用
bodyParser</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9C%A8%E8%B7%AF%E7%94%B1%E9%87%8C%E5%8A%A0%E4%B8%80%E4%B8%AA-post-%E7%A4%BA%E4%BE%8B"><span class="nav-text">3.3 在路由里加一个 POST 示例</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%98%B6%E6%AE%B5-d%E5%85%A8%E5%B1%80%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86-%E6%97%A5%E5%BF%97%E6%89%93%E5%8D%B0%E7%90%86%E8%A7%A3%E6%B4%8B%E8%91%B1%E6%A8%A1%E5%9E%8B"><span class="nav-text">4. 阶段 D：全局错误处理
+ 日志打印（理解“洋葱模型”）</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9C%A8-app.mjs-%E6%B7%BB%E5%8A%A0%E9%94%99%E8%AF%AF%E6%8D%95%E8%8E%B7%E4%B8%AD%E9%97%B4%E4%BB%B6"><span class="nav-text">4.1 在 app.mjs
添加错误捕获中间件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9C%A8%E8%B7%AF%E7%94%B1%E9%87%8C%E4%BA%BA%E4%B8%BA%E6%8A%9B%E9%94%99%E8%AF%95%E8%AF%95%E7%9C%8B"><span class="nav-text">4.2 在路由里人为抛错试试看</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%98%B6%E6%AE%B5-e%E9%9D%99%E6%80%81%E8%B5%84%E6%BA%90%E4%B8%8E-favicon%E9%81%BF%E5%85%8D%E5%A4%9A%E6%AC%A1%E8%AE%A1%E6%95%B0404"><span class="nav-text">5. 阶段 E：静态资源与
favicon（避免多次计数&#x2F;404）</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%89%E8%A3%85-koa-static"><span class="nav-text">5.1 安装 koa-static</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9C%A8%E9%A1%B9%E7%9B%AE%E6%A0%B9%E7%9B%AE%E5%BD%95%E5%BB%BA-public"><span class="nav-text">5.2 在项目根目录建
public&#x2F;</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BF%AE%E6%94%B9-app.mjs-%E5%90%AF%E7%94%A8%E9%9D%99%E6%80%81%E8%B5%84%E6%BA%90"><span class="nav-text">5.3 修改 app.mjs
启用静态资源</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%98%B6%E6%AE%B5-f%E5%8F%AF%E9%80%89%E6%A8%A1%E6%9D%BF%E6%B8%B2%E6%9F%93%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%AB%AF%E6%B8%B2%E6%9F%93%E4%B8%80%E4%B8%AA%E7%AE%80%E5%8D%95%E9%A1%B5%E9%9D%A2"><span class="nav-text">6. 阶段
F（可选）：模板渲染（服务器端渲染一个简单页面）</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%89%E8%A3%85%E4%BE%9D%E8%B5%96"><span class="nav-text">6.1 安装依赖</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84%E6%96%B0%E5%A2%9E-views"><span class="nav-text">6.2 目录结构新增 views&#x2F;</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9C%A8-app.mjs-%E9%85%8D%E7%BD%AE%E8%A7%86%E5%9B%BE%E4%B8%AD%E9%97%B4%E4%BB%B6"><span class="nav-text">6.3 在 app.mjs
配置视图中间件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9C%A8%E8%B7%AF%E7%94%B1%E4%B8%AD%E6%B8%B2%E6%9F%93%E4%B8%80%E4%B8%AA%E9%A1%B5%E9%9D%A2"><span class="nav-text">6.4 在路由中渲染一个页面</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%98%B6%E6%AE%B5-g%E9%80%90%E6%AD%A5rest-%E5%8C%96-%E7%94%A8%E5%86%85%E5%AD%98%E6%95%B0%E7%BB%84%E5%85%88%E5%81%9A-crud"><span class="nav-text">7. 阶段 G：逐步“REST 化”
—— 用内存数组先做 CRUD</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%96%B0%E5%BB%BA-routesusers.mjs"><span class="nav-text">7.1 新建
routes&#x2F;users.mjs</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9C%A8-app.mjs-%E4%B8%AD%E6%B3%A8%E5%86%8C%E6%96%B0%E8%B7%AF%E7%94%B1%E6%96%87%E4%BB%B6"><span class="nav-text">7.2 在 app.mjs
中注册新路由文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E6%95%B0%E6%8D%AE%E5%BA%93%E7%9A%84%E5%A2%9E%E5%88%A0%E6%94%B9%E6%9F%A5cura"><span class="nav-text">7.3
如何实现数据库的增删改查(CURA)</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#section"><span class="nav-text">1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253import mysql from &#39;mysql2&#x2F;promise&#39;;import dotenv from &#39;dotenv&#39;;dotenv.config();&#x2F;&#x2F; 创建连接池const pool &#x3D; mysql.createPool({  host: process.env.DB_HOST,  user: process.env.DB_USER,  password: process.env.DB_PASSWORD,  database: process.env.DB_NAME,  waitForConnections: true,  connectionLimit: 10,  queueLimit: 0});&#x2F;&#x2F; 通用 SQL 查询函数export async function query(sql, params) {  const [results] &#x3D; await pool.execute(sql, params);  return results;}&#x2F;&#x2F; ----------------- 用户增删改查 -----------------&#x2F;&#x2F; 获取所有用户export async function getAllUsers() {  return await query(&#39;SELECT * FROM users&#39;);}&#x2F;&#x2F; 根据 ID 获取用户export async function getUserById(id) {  const results &#x3D; await query(&#39;SELECT * FROM users WHERE id &#x3D; ?&#39;, [id]);  return results[0];}&#x2F;&#x2F; 新增用户export async function createUser(name, age) {  const result &#x3D; await query(&#39;INSERT INTO users (name, age) VALUES (?, ?)&#39;, [name, age]);  return { id: result.insertId, name, age };}&#x2F;&#x2F; 更新用户export async function updateUser(id, name, age) {  await query(&#39;UPDATE users SET name &#x3D; ?, age &#x3D; ? WHERE id &#x3D; ?&#39;, [name, age, id]);  return { id, name, age };}&#x2F;&#x2F; 删除用户export async function deleteUser(id) {  const result &#x3D; await query(&#39;DELETE FROM users WHERE id &#x3D; ?&#39;, [id]);  return result.affectedRows &gt; 0;}</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%98%B6%E6%AE%B5-h%E9%87%8D%E6%9E%84%E4%B8%BA-mvcmodel-view-controller%E5%88%86%E5%B1%82"><span class="nav-text">8. 阶段 H：重构为
MVC（Model-View-Controller）分层</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9B%AE%E5%BD%95%E8%B0%83%E6%95%B4"><span class="nav-text">8.1 目录调整</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#modelsusermodel.mjs%E6%95%B0%E6%8D%AE%E8%AE%BF%E9%97%AE%E5%B1%82"><span class="nav-text">8.2
models&#x2F;userModel.mjs（数据访问层）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#servicesuserservice.mjs%E4%B8%9A%E5%8A%A1%E5%B1%82"><span class="nav-text">8.3
services&#x2F;userService.mjs（业务层）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#controllersusercontroller.mjs%E6%8E%A7%E5%88%B6%E5%99%A8%E5%B1%82"><span class="nav-text">8.4
controllers&#x2F;userController.mjs（控制器层）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#routesusers.mjs%E5%8F%AA%E8%B4%9F%E8%B4%A3%E7%BB%91%E5%AE%9A%E8%B7%AF%E5%BE%84%E5%88%B0-controller"><span class="nav-text">8.5
routes&#x2F;users.mjs（只负责绑定路径到 Controller）</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%98%B6%E6%AE%B5-i%E6%8A%8A-model-%E6%8D%A2%E6%88%90-mysqlmysql2promise-%E8%BF%9E%E6%8E%A5%E6%B1%A0"><span class="nav-text">9. 阶段 I：把
Model 换成 MySQL（mysql2&#x2F;promise + 连接池）</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%89%E8%A3%85%E4%BE%9D%E8%B5%96-1"><span class="nav-text">9.1 安装依赖</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%96%B0%E5%A2%9E-databasemysql.mjs%E8%BF%9E%E6%8E%A5%E6%B1%A0%E4%B8%8E-query-%E5%B0%81%E8%A3%85"><span class="nav-text">9.2 新增
database&#x2F;mysql.mjs（连接池与 query 封装）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9C%A8%E9%A1%B9%E7%9B%AE%E6%A0%B9%E7%9B%AE%E5%BD%95%E5%88%9B%E5%BB%BA-.env"><span class="nav-text">9.3 在项目根目录创建
.env</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96%E6%95%B0%E6%8D%AE%E8%A1%A8%E4%B8%80%E6%AC%A1%E6%80%A7"><span class="nav-text">9.4 初始化数据表（一次性）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%87%8D%E5%86%99-modelsusermodel.mjs-%E4%B8%BA-mysql-%E5%AE%9E%E7%8E%B0"><span class="nav-text">9.5 重写
models&#x2F;userModel.mjs 为 MySQL 实现</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%BF%90%E8%A1%8C%E4%B8%8E%E6%B5%8B%E8%AF%95"><span class="nav-text">9.6 运行与测试</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%98%B6%E6%AE%B5-j%E9%A2%9D%E5%A4%96%E5%A2%9E%E5%BC%BA%E5%8F%AF%E9%80%89%E4%BD%86%E5%B8%B8%E7%94%A8"><span class="nav-text">10. 阶段
J：额外增强（可选但常用）</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#cors%E8%B7%A8%E5%9F%9F"><span class="nav-text">10.1 CORS（跨域）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%AF%B7%E6%B1%82%E5%8F%82%E6%95%B0%E6%A0%A1%E9%AA%8C%E8%BD%BB%E9%87%8F%E7%A4%BA%E4%BE%8B"><span class="nav-text">10.2 请求参数校验（轻量示例）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%86%E9%A1%B5-%E6%A8%A1%E7%B3%8A%E6%9F%A5%E8%AF%A2%E4%BB%A5-mysql-%E4%B8%BA%E4%BE%8B%E6%94%B9%E9%80%A0-model"><span class="nav-text">10.3 分页 &amp;
模糊查询（以 MySQL 为例，改造 Model）</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%B8%B8%E8%A7%81%E5%9D%91%E4%BD%8D%E6%8E%92%E6%9F%A5faq"><span class="nav-text">11. 常见坑位排查（FAQ）</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9C%80%E7%BB%88%E9%A1%B9%E7%9B%AE%E7%BB%93%E6%9E%84%E5%8F%82%E8%80%83%E5%88%B0%E9%98%B6%E6%AE%B5-i-%E4%B8%BA%E6%AD%A2"><span class="nav-text">12. 最终项目结构参考（到阶段 I
为止）</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%80%E5%8F%A5%E8%AF%9D%E5%9B%9E%E9%A1%BE%E6%AF%8F%E4%B8%AA%E9%98%B6%E6%AE%B5"><span class="nav-text">13. 一句话回顾每个阶段</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">

        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="koen"
      src="/./images/head.jpg">
  <p class="site-author-name" itemprop="name">koen</p>
  <div class="site-description" itemprop="description">Spark!</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">22</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">10</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">41</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/koen666" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;koen666" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:koendrunk@gmail.com" title="E-Mail → mailto:koendrunk@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="/atom.xml" title="RSS → &#x2F;atom.xml"><i class="fa fa-rss fa-fw"></i>RSS</a>
      </span>
  </div>


 
      </div>
      
        <script type="text/javascript" charset="utf-8" src="/js/tagcloud.js"></script>
        <script type="text/javascript" charset="utf-8" src="/js/tagcanvas.js"></script>
        <div class="widget-wrap">
            <h5 class="widget-title">标签云</h5>
            <div id="myCanvasContainer" class="widget tagcloud">
                <canvas width="250" height="250" id="resCanvas" style="width:100%">
                    <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/AnyLabeling/" rel="tag">AnyLabeling</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/KL/" rel="tag">KL</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Koa/" rel="tag">Koa</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MAC/" rel="tag">MAC</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/RE-ID/" rel="tag">RE-ID</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Transformer/" rel="tag">Transformer</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/argparse/" rel="tag">argparse</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/backen/" rel="tag">backen</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/cmd/" rel="tag">cmd</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/collections/" rel="tag">collections</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/container/" rel="tag">container</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/curl/" rel="tag">curl</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/database/" rel="tag">database</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/dataloader/" rel="tag">dataloader</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/dataset/" rel="tag">dataset</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/deeplearning/" rel="tag">deeplearning</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/desk/" rel="tag">desk</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/docker/" rel="tag">docker</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/electron/" rel="tag">electron</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/git/" rel="tag">git</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/gradio/" rel="tag">gradio</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ip/" rel="tag">ip</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/latex/" rel="tag">latex</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/learn/" rel="tag">learn</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux/" rel="tag">linux</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/markdown/" rel="tag">markdown</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/math/" rel="tag">math</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/nodejs/" rel="tag">nodejs</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/pipenv/" rel="tag">pipenv</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/python/" rel="tag">python</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/pytorch/" rel="tag">pytorch</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/repo/" rel="tag">repo</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/router/" rel="tag">router</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/saaborn/" rel="tag">saaborn</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/scipy/" rel="tag">scipy</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/sql/" rel="tag">sql</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/virtual/" rel="tag">virtual</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/vue/" rel="tag">vue</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/web/" rel="tag">web</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/yaml/" rel="tag">yaml</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/yolo/" rel="tag">yolo</a><span class="tag-list-count">1</span></li></ul>
                </canvas>
            </div>
        </div>
      
        <div class="back-to-top motion-element">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

     <!-- aplayer -->
    <div id="aplayer"></div>
    <script type="text/javascript" src="/dist/APlayer.min.js"></script>
    <script type="text/javascript" src="/dist/music.js"></script>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">koen</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="Symbols count total">45k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="Reading time total">41 mins.</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a>
  </div><!-- 页面点击小红心 -->
<script type="text/javascript" src="/js/love.js"></script>

<!-- 引入 jQuery -->
<script type="text/javascript" src="http://libs.baidu.com/jquery/1.8.3/jquery.js"></script>
<script type="text/javascript" src="http://libs.baidu.com/jquery/1.8.3/jquery.min.js"></script>

<!-- 引入雪花脚本 -->
<script type="text/javascript" src="/js/snow.js"></script>


  <div id="site-runtime">
<span class="post-meta-item-icon">
    <i class="fa fa-clock-o"></i>
</span>
<span id="runtime"></span>
</div>
​
<script language="javascript">
function isPC() {
    var userAgentInfo = navigator.userAgent;
    var agents = ["Android", "iPhone", "SymbianOS", "Windows Phone", "iPad", "iPod"];
    for (var i = 0; i < agents.length; i++) {
    if (userAgentInfo.indexOf(agents[i]) > 0) {
        return false;
    }
    }
    return true;
}
​
function siteTime(openOnPC, start) {
    window.setTimeout("siteTime(openOnPC, start)", 1000);
    var seconds = 1000;
    var minutes = seconds * 60;
    var hours = minutes * 60;
    var days = hours * 24;
    var years = days * 365;
​
    start = new Date("2022-04-15 13:13:00 +0800");
    var now = new Date();
    var year = now.getFullYear();
    var month = now.getMonth() + 1;
    var date = now.getDate();
    var hour = now.getHours();
    var minute = now.getMinutes();
    var second = now.getSeconds();
    var diff = now - start;
​
    var diffYears = Math.floor(diff / years);
    var diffDays = Math.floor((diff / days) - diffYears * 365);
    var diffHours = Math.floor((diff - (diffYears * 365 + diffDays) * days) / hours);
    var diffMinutes = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours) / minutes);
    var diffSeconds = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours - diffMinutes * minutes) / seconds);
​
    if (openOnPC) {
        if (diffYears == 0){
            document.getElementById("runtime").innerHTML = "本站已安全运行: " + diffDays + " 天 " + diffHours + " 小时 " + diffMinutes + " 分钟 " + diffSeconds + " 秒";
        }else{
            document.getElementById("runtime").innerHTML = "本站已安全运行: " + diffYears + " 年 " + diffDays + " 天 " + diffHours + " 小时 " + diffMinutes + " 分钟 " + diffSeconds + " 秒";
        }
    } else {
        if (y == 0){
            document.getElementById("runtime").innerHTML = "本站已安全运行: " + diffDays + "天 " + diffHours + "小时 " + diffMinutes + "分钟 " + diffSeconds + "秒";
        }else{
            document.getElementById("runtime").innerHTML = "本站已安全运行: " + diffYears + "年 " + diffDays + "天 " + diffHours + "小时 " + diffMinutes + "分钟 " + diffSeconds + "秒";
        }
    
    }
}
​
var showOnMobile = false;
var openOnPC = isPC();
var start = new Date();
siteTime(openOnPC, start);
​
if (!openOnPC && !showOnMobile) {
    document.getElementById('site-runtime').style.display = 'none';
}
</script>
        
<div class="busuanzi-count">
  <script data-pjax async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="Total Visitors">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="Total Views">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  
  <script color='0,0,0' opacity='1' zIndex='-1' count='99' src="/lib/canvas-nest/canvas-nest.min.js"></script>
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/pjax/pjax.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/medium-zoom@1/dist/medium-zoom.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>

  <script>
var pjax = new Pjax({
  selectors: [
    'head title',
    '#page-configurations',
    '.content-wrap',
    '.post-toc-wrap',
    '.languages',
    '#pjax'
  ],
  switches: {
    '.post-toc-wrap': Pjax.switches.innerHTML
  },
  analytics: false,
  cacheBust: false,
  scrollTo : !CONFIG.bookmark.enable
});

window.addEventListener('pjax:success', () => {
  document.querySelectorAll('script[data-pjax], script#page-configurations, #pjax script').forEach(element => {
    var code = element.text || element.textContent || element.innerHTML || '';
    var parent = element.parentNode;
    parent.removeChild(element);
    var script = document.createElement('script');
    if (element.id) {
      script.id = element.id;
    }
    if (element.className) {
      script.className = element.className;
    }
    if (element.type) {
      script.type = element.type;
    }
    if (element.src) {
      script.src = element.src;
      // Force synchronous loading of peripheral JS.
      script.async = false;
    }
    if (element.dataset.pjax !== undefined) {
      script.dataset.pjax = '';
    }
    if (code !== '') {
      script.appendChild(document.createTextNode(code));
    }
    parent.appendChild(script);
  });
  NexT.boot.refresh();
  // Define Motion Sequence & Bootstrap Motion.
  if (CONFIG.motion.enable) {
    NexT.motion.integrator
      .init()
      .add(NexT.motion.middleWares.subMenu)
      .add(NexT.motion.middleWares.postList)
      .bootstrap();
  }
  NexT.utils.updateSidebarPosition();
});
</script>




  




  
<script src="/js/local-search.js"></script>













    <div id="pjax">
  

  
      

<script>
  if (typeof MathJax === 'undefined') {
    window.MathJax = {
      loader: {
        source: {
          '[tex]/amsCd': '[tex]/amscd',
          '[tex]/AMScd': '[tex]/amscd'
        }
      },
      tex: {
        inlineMath: {'[+]': [['$', '$']]},
        tags: 'ams'
      },
      options: {
        renderActions: {
          findScript: [10, doc => {
            document.querySelectorAll('script[type^="math/tex"]').forEach(node => {
              const display = !!node.type.match(/; *mode=display/);
              const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display);
              const text = document.createTextNode('');
              node.parentNode.replaceChild(text, node);
              math.start = {node: text, delim: '', n: 0};
              math.end = {node: text, delim: '', n: 0};
              doc.math.push(math);
            });
          }, '', false],
          insertedScript: [200, () => {
            document.querySelectorAll('mjx-container').forEach(node => {
              let target = node.parentNode;
              if (target.nodeName.toLowerCase() === 'li') {
                target.parentNode.classList.add('has-jax');
              }
            });
          }, '', false]
        }
      }
    };
    (function () {
      var script = document.createElement('script');
      script.src = '//cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js';
      script.defer = true;
      document.head.appendChild(script);
    })();
  } else {
    MathJax.startup.document.state(0);
    MathJax.texReset();
    MathJax.typeset();
  }
</script>

    

  

<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.css">

<script>
NexT.utils.loadComments(document.querySelector('#gitalk-container'), () => {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js', () => {
    var gitalk = new Gitalk({
      clientID    : 'Ov23liWNrNurmdCCSe44',
      clientSecret: 'e99bd9bd840b672d12d0c6ce1824f8bcaa26ee9d',
      repo        : 'koen666.github.io',
      owner       : 'koen666',
      admin       : ['koen666'],
      id          : '93e777df4f1765daf95544e3b4ebb92e',
        language: '',
      distractionFreeMode: true
    });
    gitalk.render('gitalk-container');
  }, window.Gitalk);
});
</script>


    </div>
<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body>
</html>
