{
    "version": "https://jsonfeed.org/version/1",
    "title": "木语 • All posts by \"docker\" category",
    "description": "Spark!",
    "home_page_url": "http://example.com",
    "items": [
        {
            "id": "http://example.com/2026/01/15/udocker/",
            "url": "http://example.com/2026/01/15/udocker/",
            "title": "让你在没有 root 权限的机子上跑镜像",
            "date_published": "2026-01-14T16:00:00.000Z",
            "content_html": "<h2 id=\"背景为什么我们需要它\"><a class=\"anchor\" href=\"#背景为什么我们需要它\">#</a> 背景：为什么我们需要它？</h2>\n<p>在科研和开发过程中，我们经常遇到这样的死结：</p>\n<ol>\n<li><strong>环境依赖地狱</strong>：代码依赖特定的 CUDA 版本、Ubuntu 版本或一大堆 Python 库，手动配置极易冲突。</li>\n<li><strong>没有 Root 权限</strong>：实验室的服务器、学校的 HPC 集群通常由管理员统一管理，普通学生账户没有 <code>sudo</code> 权限。</li>\n<li><strong>Docker 无法使用</strong>：标准的 Docker 需要守护进程（Daemon）以 root 身份运行，没有权限意味着 <code>docker: command not found</code> 或 <code>permission denied</code>。</li>\n</ol>\n<p>虽然 <strong>Podman</strong> 是一个很好的无 Root 替代品，但它对 Linux 内核版本有要求（需要 User Namespaces 支持），且在某些老旧的超算系统上仍然难以安装。</p>\n<p>这时候，<strong>udocker</strong> 就是一个非常实用的解决方案。</p>\n<h2 id=\"什么是-udocker\"><a class=\"anchor\" href=\"#什么是-udocker\">#</a> 什么是 udocker？</h2>\n<p><code>udocker</code> 是一个专门为在用户空间运行 Docker 容器而设计的工具：</p>\n<ul>\n<li><strong>纯用户空间</strong>：不需要 root 权限，也不需要安装系统级守护进程。</li>\n<li><strong>兼容性强</strong>：本质上是一个 Python 脚本，几乎可以在任何 Linux 发行版（CentOS 6/7、Ubuntu、Fedora 等）上运行。</li>\n<li><strong>原理</strong>：通过 <strong>PRoot</strong>（利用 <code>ptrace</code> 机制）或 <strong>Fakechroot</strong> 等技术，模拟 root 环境和文件系统挂载，让容器“以为”自己运行在特权环境中。</li>\n</ul>\n<p>一句话总结：<strong>只要你能跑 Python，就能跑 udocker，进而跑 Docker 镜像。</strong></p>\n<h2 id=\"1-安装-udocker\"><a class=\"anchor\" href=\"#1-安装-udocker\">#</a> 1. 安装 udocker</h2>\n<p>安装过程很简单：下载脚本并初始化。</p>\n<h3 id=\"11-下载-udocker-脚本\"><a class=\"anchor\" href=\"#11-下载-udocker-脚本\">#</a> 1.1 下载 udocker 脚本</h3>\n<pre class=\"shiki shiki-themes vitesse-light vitesse-dark\" style=\"background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee\" tabindex=\"0\"><code class=\"language-bash\"><span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">curl</span><span style=\"color:#A65E2B;--shiki-dark:#C99076\"> -L</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> https://raw.githubusercontent.com/indigo-dc/udocker/master/udocker.py</span><span style=\"color:#AB5959;--shiki-dark:#CB7676\"> </span><span style=\"color:#AB5959;--shiki-dark:#CB7676\">></span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> udocker</span></span></code></pre>\n<h3 id=\"12-赋予执行权限\"><a class=\"anchor\" href=\"#12-赋予执行权限\">#</a> 1.2 赋予执行权限</h3>\n<pre class=\"shiki shiki-themes vitesse-light vitesse-dark\" style=\"background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee\" tabindex=\"0\"><code class=\"language-bash\"><span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">chmod</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> +x</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> udocker</span></span></code></pre>\n<h3 id=\"13-移动到你的-bin-目录可选\"><a class=\"anchor\" href=\"#13-移动到你的-bin-目录可选\">#</a> 1.3 移动到你的 bin 目录（可选）</h3>\n<p>前提：<code>~/.local/bin</code> 已在 <code>PATH</code> 中。</p>\n<pre class=\"shiki shiki-themes vitesse-light vitesse-dark\" style=\"background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee\" tabindex=\"0\"><code class=\"language-bash\"><span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">mv</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> udocker</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> ~/.local/bin/</span></span></code></pre>\n<h3 id=\"14-初始化\"><a class=\"anchor\" href=\"#14-初始化\">#</a> 1.4 初始化</h3>\n<p>这会自动下载所需的引擎二进制文件到 <code>~/.udocker</code> 目录。</p>\n<pre class=\"shiki shiki-themes vitesse-light vitesse-dark\" style=\"background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee\" tabindex=\"0\"><code class=\"language-bash\"><span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">udocker</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> install</span></span></code></pre>\n<h3 id=\"15-验证安装\"><a class=\"anchor\" href=\"#15-验证安装\">#</a> 1.5 验证安装</h3>\n<pre class=\"shiki shiki-themes vitesse-light vitesse-dark\" style=\"background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee\" tabindex=\"0\"><code class=\"language-bash\"><span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">udocker</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> version</span></span></code></pre>\n<h2 id=\"2-基本使用像-docker-一样操作\"><a class=\"anchor\" href=\"#2-基本使用像-docker-一样操作\">#</a> 2. 基本使用：像 Docker 一样操作</h2>\n<p>udocker 的命令设计上尽量模仿 Docker，但有一个关键区别：<strong>udocker 严格区分“容器创建”和“容器运行”。</strong></p>\n<h3 id=\"21-拉取镜像pull\"><a class=\"anchor\" href=\"#21-拉取镜像pull\">#</a> 2.1 拉取镜像（pull）</h3>\n<pre class=\"shiki shiki-themes vitesse-light vitesse-dark\" style=\"background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee\" tabindex=\"0\"><code class=\"language-bash\"><span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\"># 拉取 PyTorch 镜像</span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">udocker</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> pull</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> pytorch/pytorch:1.13.0-cuda11.6-cudnn8-runtime</span></span></code></pre>\n<h3 id=\"22-创建容器create\"><a class=\"anchor\" href=\"#22-创建容器create\">#</a> 2.2 创建容器（create）</h3>\n<p>在 Docker 中，<code>docker run</code> 常同时完成创建和启动；在 udocker 中，更推荐先显式创建容器。</p>\n<pre class=\"shiki shiki-themes vitesse-light vitesse-dark\" style=\"background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee\" tabindex=\"0\"><code class=\"language-bash\"><span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\"># 从镜像创建一个名为 \"my_experiment\" 的容器</span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">udocker</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> create</span><span style=\"color:#A65E2B;--shiki-dark:#C99076\"> --name=my_experiment</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> pytorch/pytorch:1.13.0-cuda11.6-cudnn8-runtime</span></span></code></pre>\n<h3 id=\"23-运行容器run\"><a class=\"anchor\" href=\"#23-运行容器run\">#</a> 2.3 运行容器（run）</h3>\n<pre class=\"shiki shiki-themes vitesse-light vitesse-dark\" style=\"background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee\" tabindex=\"0\"><code class=\"language-bash\"><span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\"># 运行容器并进入交互式终端</span></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\"># -v 挂载目录：将宿主机当前目录挂载到容器的 /workspace</span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">udocker</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> run</span><span style=\"color:#A65E2B;--shiki-dark:#C99076\"> -v</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\"> \"</span><span style=\"color:#999999;--shiki-dark:#666666\">$(</span><span style=\"color:#998418;--shiki-dark:#B8A965\">pwd</span><span style=\"color:#999999;--shiki-dark:#666666\">)</span><span style=\"color:#B5695977;--shiki-dark:#C98A7D77\">\"</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\">:/workspace</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> my_experiment</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> /bin/bash</span></span></code></pre>\n<p>进入容器后，你会看到自己是 root（容器内部视角）。你可以 <code>apt-get install</code> 或 <code>pip install</code>，但这些改动只影响容器文件系统，不会影响宿主机。</p>\n<h2 id=\"3-进阶技巧科研场景专用\"><a class=\"anchor\" href=\"#3-进阶技巧科研场景专用\">#</a> 3. 进阶技巧：科研场景专用</h2>\n<h3 id=\"31-启用-gpu-支持nvidia\"><a class=\"anchor\" href=\"#31-启用-gpu-支持nvidia\">#</a> 3.1 启用 GPU 支持（NVIDIA）</h3>\n<pre class=\"shiki shiki-themes vitesse-light vitesse-dark\" style=\"background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee\" tabindex=\"0\"><code class=\"language-bash\"><span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\"># 使用 --nvidia 标志启用 GPU 支持</span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">udocker</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> run</span><span style=\"color:#A65E2B;--shiki-dark:#C99076\"> --nvidia</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> my_experiment</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> nvidia-smi</span></span></code></pre>\n<p>注意：udocker <strong>不包含</strong>驱动程序，它只是将宿主机的 <code>/dev/nvidia*</code> 设备和相关库映射进容器。请确保宿主机已正确安装显卡驱动。</p>\n<h3 id=\"32-更改运行模式execmode\"><a class=\"anchor\" href=\"#32-更改运行模式execmode\">#</a> 3.2 更改运行模式（execmode）</h3>\n<p>如果遇到 <code>Segmentation fault</code> 或某些程序跑不起来，可以尝试更改执行模式。udocker 提供多种模式（不同版本的可用项可能略有差异）：</p>\n<ul>\n<li><strong>P1/P2（PRoot）</strong>：默认模式，兼容性最好，但 I/O 密集任务可能有性能损耗。</li>\n<li><strong>F1/F2/F3（Fakechroot）</strong>：性能更好，但兼容性可能稍差。</li>\n<li><strong>R1（RunC）</strong>：若内核/环境满足条件，性能接近原生 Docker。</li>\n</ul>\n<p>查看当前模式：</p>\n<pre class=\"shiki shiki-themes vitesse-light vitesse-dark\" style=\"background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee\" tabindex=\"0\"><code class=\"language-bash\"><span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">udocker</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> setup</span><span style=\"color:#A65E2B;--shiki-dark:#C99076\"> --execmode</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> my_experiment</span></span></code></pre>\n<p>切换为某个模式（示例：F3）：</p>\n<pre class=\"shiki shiki-themes vitesse-light vitesse-dark\" style=\"background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee\" tabindex=\"0\"><code class=\"language-bash\"><span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">udocker</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> setup</span><span style=\"color:#A65E2B;--shiki-dark:#C99076\"> --execmode=F3</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> my_experiment</span></span></code></pre>\n<h2 id=\"4-常见问题与局限\"><a class=\"anchor\" href=\"#4-常见问题与局限\">#</a> 4. 常见问题与局限</h2>\n<h3 id=\"41-端口映射\"><a class=\"anchor\" href=\"#41-端口映射\">#</a> 4.1 端口映射</h3>\n<p>udocker 默认使用宿主机网络栈（Host Mode）。因此通常不能像 Docker 那样用 <code>-p 8080:80</code> 做 NAT 端口转发。</p>\n<ul>\n<li>如果容器内服务监听 <code>8000</code>，它往往就是在宿主机的 <code>8000</code> 上监听。</li>\n</ul>\n<h3 id=\"42-安全性\"><a class=\"anchor\" href=\"#42-安全性\">#</a> 4.2 安全性</h3>\n<p>udocker 的目标偏向“可用性”，而不是强隔离。不要在容器里运行不可信/恶意代码，因为它可能影响当前用户可访问的文件（例如你的 <code>HOME</code> 目录）。</p>\n<h3 id=\"43-清理与空间占用\"><a class=\"anchor\" href=\"#43-清理与空间占用\">#</a> 4.3 清理与空间占用</h3>\n<p>容器文件默认存储在 <code>~/.udocker/containers</code> 下，不用的容器/镜像建议定期清理：</p>\n<pre class=\"shiki shiki-themes vitesse-light vitesse-dark\" style=\"background-color:#ffffff;--shiki-dark-bg:#121212;color:#393a34;--shiki-dark:#dbd7caee\" tabindex=\"0\"><code class=\"language-bash\"><span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\"># 删除容器</span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">udocker</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> rm</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> my_experiment</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color:#A0ADA0;--shiki-dark:#758575DD\"># 删除镜像（按实际 tag 替换）</span></span>\n<span class=\"line\"><span style=\"color:#59873A;--shiki-dark:#80A665\">udocker</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> rmi</span><span style=\"color:#B56959;--shiki-dark:#C98A7D\"> pytorch/pytorch:xxxx</span></span></code></pre>\n<h2 id=\"总结\"><a class=\"anchor\" href=\"#总结\">#</a> 总结</h2>\n<p>在受限的服务器或 HPC 环境下，udocker 可以在<strong>无需 root 权限</strong>的前提下运行容器化环境，适合解决“在别人的机器上跑我的环境”这一类问题。</p>\n<p>如果你在集群上装不上 Docker，又想复用 Docker Hub 上现成镜像，可以优先试试 udocker。</p>\n",
            "tags": [
                "docker",
                "images",
                "hpc",
                "tutorial"
            ]
        }
    ]
}